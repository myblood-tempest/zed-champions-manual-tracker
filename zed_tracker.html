<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zed Champions Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Basic Reset & Variables */
        :root {
            --bg-color: #1a1a1a;
            --text-color: #f0f0f0;
            --text-muted-color: #a0a0a0;
            --border-color: #444; /* Default border */
            --border-color-stars: #7d681f; /* Subtle gold/yellow for stars */
            --border-color-parent: #5e5570; /* Subtle purple for lineage */
            --border-color-money: #2a704a;  /* Subtle green for currency */
            --accent-color: #3498db; /* Brighter Blue accent (Used for focus) */
            --link-color: #85c1e9;  /* Brighter Light Blue link */
            --input-bg: #333;
            --button-bg: #2e86c1;  /* Brighter Button Blue */
            --button-hover-bg: #2471a3; /* Deeper blue for hover */
            --tab-bg: #2a2a2a;
            --tab-active-bg: #3a3a3a;
            --section-bg: #252525; /* Slightly darker section background */
            --error-color: #f44336;
            --success-color: #4caf50;
            --title-font: 'Orbitron', sans-serif;
            --body-font: 'Inter', sans-serif;
            --text-highlight-bg: var(--bg-color); /* Use main bg for TH text highlight */
        }

        body {
            font-family: var(--body-font);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        h1, h2, h3 {
            color: var(--accent-color);
            padding-bottom: 0.3em;
            margin-top: 1.5em;
            margin-bottom: 1em;
        }
        h1 {
            font-size: 2.2em; /* Slightly larger */
            font-family: var(--title-font);
            font-weight: 700; /* Boldness for Orbitron */
            letter-spacing: 1px; /* Slight spacing */
        }
        h2 { 
            font-size: 1.6em; 
            border-bottom: 1px solid var(--border-color); /* Restore original border */
            padding-bottom: 0.3em; /* Restore original padding */
        }
        h3 { 
            font-size: 1.3em; 
            margin-top: 1em; 
            border-bottom: none; /* Explicitly no border */
        }

        /* Layout & Sections */
        .section {
            background-color: var(--section-bg);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
            transition: all 0.2s ease-in-out;
            margin-bottom: 30px; /* Increased space between sections */
        }

        /* Forms */
        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 5px; /* Subtle padding */
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Responsive grid */
            gap: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-muted-color);
            font-size: 0.9em; /* Slightly smaller for refinement */
            letter-spacing: 0.5px; /* Subtle letter spacing */
        }
        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--input-bg);
            color: var(--text-color);
            box-sizing: border-box; /* Include padding in width */
            transition: all 0.2s ease;
            height: 42px; /* Standardize height */
            outline: none; /* Remove default focus outline */
        }
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); /* Subtle glow effect */
        }
        select {
            appearance: none; /* Custom dropdown arrow styling might be needed */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 24 24' fill='none' stroke='%23a0a0a0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 30px; /* Space for the arrow */
        }
        button[type="submit"], .button {
            background-color: var(--button-bg);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
            align-self: flex-start; /* Align button to the start */
            height: 44px; /* Standardize height */
            font-weight: 500; /* Slightly bolder */
            letter-spacing: 0.5px; /* Subtle letter spacing */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); /* Subtle drop shadow */
            transition: all 0.2s ease;
        }
        button[type="submit"]:hover, .button:hover {
            background-color: var(--button-hover-bg);
            box-shadow: 0 4px 8px rgba(0,0,0,0.25); /* Enhanced shadow on hover */
            transform: translateY(-1px); /* Subtle lift effect */
        }
        button[type="submit"]:active, .button:active {
            transform: translateY(1px); /* Subtle press effect */
            box-shadow: 0 1px 2px rgba(0,0,0,0.15); /* Reduced shadow when pressed */
        }
        .action-button {
            padding: 6px; /* Adjust padding for icons */
            font-size: 0.9em;
            margin-right: 5px;
            min-width: 60px; /* Ensure minimum width for buttons */
            width: 32px; /* Fixed width for square look */
            height: 32px; /* Fixed height for square look */
            min-width: auto; /* Override previous min-width */
            line-height: 1; /* Align icon vertically */
            display: inline-flex; /* Align icon center */
            align-items: center;
            justify-content: center;
            border-radius: 4px; /* Slightly rounded */
        }
        .action-button svg {
            width: 16px; /* Icon size */
            height: 16px; /* Icon size */
            stroke-width: 2px; /* Consistent stroke */
            vertical-align: middle; /* Align icon */
        }
        .delete-button {
            background-color: var(--error-color);
        }
        .delete-button:hover {
            background-color: #d32f2f; /* Darker red */
        }

        /* Style for visually grouping star inputs */
        .star-input-field {
            background-color: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 5px;
            margin-top: 5px; /* Add some space above the group */
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* Subtle shadow for depth */
            overflow: hidden; /* Ensures the border-radius is respected */
            border-radius: 4px; /* Rounded corners */
        }
        th, td {
            border: 1px solid var(--border-color);
            padding: 12px;
            text-align: left;
            transition: background-color 0.15s ease; /* Smooth transition */
        }
        th {
            background-color: var(--tab-active-bg);
            color: var(--accent-color);
            font-weight: bold;
            /* Apply highlight effect */
            background-color: var(--text-highlight-bg); /* Keep main bg color for TH */
            padding: 8px 12px; /* Adjust padding for highlight */
            border-radius: 3px 3px 0 0; /* Round top corners */
            /* We might need to adjust border styles if this looks odd */
            letter-spacing: 0.7px; /* Slightly increase letter spacing */
            text-transform: uppercase; /* UPPERCASE for headers */
            font-size: 0.85em; /* Slightly smaller text */
        }
        tbody tr:nth-child(odd) {
            background-color: var(--section-bg); /* Slightly different for striping */
        }
        tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.08); /* Subtle blue highlight on hover */
            cursor: default; /* Show this is interactive */
        }
        /* Adding subtle animation for buttons within tables */
        tbody tr td button {
            transition: all 0.2s ease;
        }
        tbody tr:hover td button {
            transform: translateX(2px); /* Subtle shift on row hover */
        }

        /* Tabs */
        #tab-buttons {
            display: flex;
            gap: 5px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 25px; /* More space below tabs */
            padding-bottom: 2px; /* Subtle padding below tabs */
        }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background-color: var(--tab-bg);
            color: var(--text-muted-color);
            border-radius: 5px 5px 0 0;
            font-size: 1em;
            transition: all 0.2s ease; /* Smooth transition */
            position: relative; /* For indicator */
            letter-spacing: 0.5px; /* Subtle spacing */
        }
        .tab-button.active {
            background-color: var(--section-bg); /* Match active tab content bg */
            color: var(--accent-color);
            font-weight: bold;
            border: 1px solid var(--border-color);
            border-bottom: 1px solid var(--section-bg); /* Hide bottom border */
            position: relative;
            top: 1px; /* Align with content area */
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1); /* Subtle shadow on active tab */
        }
        /* Add subtle hover effect for non-active tabs */
        .tab-button:not(.active):hover {
            background-color: rgba(52, 152, 219, 0.1); /* Very subtle blue hover */
            color: var(--link-color); /* Lighter blue on hover */
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out; /* Subtle fade in animation */
        }
        /* Add animation keyframes */
        @keyframes fadeIn {
            from { opacity: 0.85; }
            to { opacity: 1; }
        }

        /* Augments List Specific */
        #augments-list ul {
            list-style: none;
            padding: 0;
            column-count: 3; /* Display in columns */
            column-gap: 20px;
            margin-top: 10px; /* Add some space below the heading */
        }
        #augments-list li {
            margin-bottom: 8px;
            background-color: var(--input-bg);
            padding: 8px 12px; /* Slightly adjust padding */
            border-radius: 4px; /* Match other elements */
            transition: all 0.2s ease; /* Added smooth transition */
            display: flex; /* Use flexbox */
            justify-content: space-between; /* Push button to the right */
            align-items: center; /* Vertically align items */
        }
        #augments-list li span { /* Target the text span */
            flex-grow: 1; /* Allow text to take available space */
            margin-right: 10px; /* Space between text and button */
        }
        #augments-list li:hover {
            transform: translateX(2px); /* Subtle shift on hover */
            background-color: var(--tab-active-bg); /* Use tab active bg for hover */
        }
        /* Styling for the delete button within the augment list */
        .augment-manage-list button {
            padding: 4px; /* Reduce padding */
            width: auto; /* Let icon size dictate width */
            height: auto; /* Let icon size dictate height */
            background: none; /* Remove default background */
            border: none; /* Remove border */
            box-shadow: none; /* Remove shadow */
            cursor: pointer;
            opacity: 0.6; /* Make it less prominent initially */
            transition: all 0.2s ease;
        }
        .augment-manage-list button svg {
            stroke: var(--text-muted-color); /* Muted icon color */
            width: 18px; /* Slightly larger icon */
            height: 18px;
        }
        /* Enhance button on list item hover */
        #augments-list li:hover button {
            opacity: 1;
        }
        #augments-list li:hover button svg {
            stroke: var(--error-color); /* Red icon on hover */
        }

        /* Stats Specific */
        #overall-stats p {
            font-size: 1.1em;
            background-color: var(--input-bg);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            transition: all 0.2s ease; /* Added smooth transition */
        }
        #overall-stats p:hover {
            background-color: rgba(52, 152, 219, 0.08); /* Subtle highlight on hover */
        }
        #overall-stats strong {
            color: var(--accent-color);
            min-width: 180px;
            display: inline-block;
        }

        /* Modal Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7); /* Darker backdrop */
            backdrop-filter: blur(2px); /* Subtle blur effect (works in modern browsers) */
        }
        .modal-content {
            background-color: var(--section-bg);
            margin: 10% auto; /* Centered */
            padding: 30px;
            border: 1px solid var(--border-color);
            width: 80%;
            max-width: 700px; /* Max width */
            border-radius: 8px;
            position: relative;
            box-shadow: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
            animation: modalIn 0.3s ease-out; /* Modal entry animation */
        }
        /* Modal animation keyframes */
        @keyframes modalIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-close {
            color: var(--text-muted-color);
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: var(--text-color);
            transform: scale(1.1); /* Slight grow effect */
        }
        .modal-content h3 {
            color: var(--accent-color);
            margin-top: 0;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5em;
        }
         .modal-stats p {
             margin: 0.5em 0;
             font-size: 1.1em;
         }
         .modal-stats strong {
             color: var(--text-muted-color);
             min-width: 100px;
             display: inline-block;
         }
         .modal-content table {
             margin-top: 1.5em;
         }

        /* Sortable Table Header Styling */
        #horses-table th[data-sort-key] {
            cursor: pointer;
            position: relative;
        }
        #horses-table th[data-sort-key]::after {
            content: '\00a0\2195'; /* Up/Down arrow, non-breaking space */
            opacity: 0.3;
            position: absolute;
            right: 0.5em;
            top: 50%;
            transform: translateY(-50%);
        }
        #horses-table th.sort-asc[data-sort-key]::after,
        #horses-table th.sort-desc[data-sort-key]::after {
            opacity: 1;
        }
        #horses-table th.sort-asc[data-sort-key]::after {
            content: '\00a0\25B2'; /* Up arrow */
        }
        #horses-table th.sort-desc[data-sort-key]::after {
            content: '\00a0\25BC'; /* Down arrow */
        }

        /* Specific Column Widths for Racing Table */
        /* Remove specific widths for most columns - let table-layout:fixed distribute */
        #horses-table th:nth-child(3), /* Gender */
        #horses-table td:nth-child(3),
        #horses-table th:nth-child(5), /* MMR */
        #horses-table td:nth-child(5),
        #horses-table th:nth-child(8), /* Win % */
        #horses-table td:nth-child(8),
        #horses-table th:nth-child(9), /* Races */
        #horses-table td:nth-child(9),
        #horses-table th:nth-child(7) /* W-P-S */
        /* #horses-table td:nth-child(7) REMOVED width */
        {
             text-align: center;
        }

        /* Add specific column widths to make the table more compact */
        #horses-table th:nth-child(3), /* Gender */
        #horses-table td:nth-child(3) {
            width: 80px;
        }
        
        #horses-table th:nth-child(5), /* MMR */
        #horses-table td:nth-child(5) {
            width: 70px;
        }
        
        #horses-table th:nth-child(7), /* W-P-S */
        #horses-table td:nth-child(7) {
            width: 80px;
            text-align: center;
        }
        
        #horses-table th:nth-child(8), /* Win % */
        #horses-table td:nth-child(8) {
            width: 70px;
        }
        
        #horses-table th:nth-child(9), /* Races */
        #horses-table td:nth-child(9) {
            width: 70px;
        }
        
        #horses-table th:nth-child(10), /* Actions */
        #horses-table td:nth-child(10) {
            width: 100px;
            text-align: center;
        }

        /* Explicitly center W-P-S */
        #horses-table th:nth-child(7),
        #horses-table td:nth-child(7)
        {
             text-align: center;
        }

        #horses-table th:nth-child(6), /* $ZED Bal */
        #horses-table td:nth-child(6) /* REMOVED width */
        {
             text-align: center; /* Center align for balance */
             width: 80px; /* Set explicit width */
        }

        #horses-table th:nth-child(4), /* Stars */
        #horses-table td:nth-child(4)
        {
             text-align: center;
             width: 120px; /* Reduce width again */
        }

        /* Keep Actions width - Increase slightly for 3 buttons */
        #horses-table th:nth-child(11), /* Actions (shifted due to new col) */
        #horses-table td:nth-child(11) {
             width: 120px; /* Increased width */
             text-align: center;
        }

        /* Give Bloodline a specific width */
        #horses-table th:nth-child(2), /* Bloodline */
        #horses-table td:nth-child(2),
        #horses-table th:nth-child(10), /* Races (shifted) */
        #horses-table td:nth-child(10)
        {
             width: 120px; /* Explicit width for Bloodline */
             text-align: center;
        }

        /* General table styles */
        #horses-table {
             /* Remove width: 100% to allow table to shrink */
            max-width: 1425px; /* Set a max-width to prevent excessive stretching */
            table-layout: fixed; /* Use fixed layout for more predictable widths */
            border-collapse: collapse;
            margin-top: 20px;
        }

        /* Subtle Border Colors for Field Types */
        /* Stars (Racing, Breeding, External Sire) */
        #horse-stars, #horse-speed-stars, #horse-sprint-stars, #horse-endurance-stars,
        #breeding-horse-stars, #breeding-horse-speed-stars, #breeding-horse-sprint-stars, #breeding-horse-endurance-stars,
        #bred-overall-stars, #bred-speed-stars, #bred-sprint-stars, #bred-endurance-stars,
        #external-sire-overall-stars, #external-sire-speed-stars, #external-sire-sprint-stars, #external-sire-endurance-stars {
            border-color: var(--border-color-stars);
        }
        /* Parent Selects */
        #bred-sire, #bred-dam {
            border-color: var(--border-color-parent);
        }
        /* Financial Fields */
        #horse-zed-balance, #race-zed-change, #bred-stud-fee {
            border-color: var(--border-color-money);
        }

        /* Ensure focus state overrides subtle borders */
        #horse-stars:focus, #horse-speed-stars:focus, #horse-sprint-stars:focus, #horse-endurance-stars:focus,
        #breeding-horse-stars:focus, #breeding-horse-speed-stars:focus, #breeding-horse-sprint-stars:focus, #breeding-horse-endurance-stars:focus,
        #bred-overall-stars:focus, #bred-speed-stars:focus, #bred-sprint-stars:focus, #bred-endurance-stars:focus,
        #external-sire-overall-stars:focus, #external-sire-speed-stars:focus, #external-sire-sprint-stars:focus, #external-sire-endurance-stars:focus,
        #bred-sire:focus, #bred-dam:focus,
        #horse-zed-balance:focus, #race-zed-change:focus, #bred-stud-fee:focus {
            border-color: var(--accent-color); /* Use standard focus color */
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); /* Restore standard glow */
        }

        /* Default Form Grid Layouts */
        #add-horse-form .form-grid {
            grid-template-columns: repeat(5, 1fr);
            align-items: end;
        }
        #add-race-form .form-grid {
            grid-template-columns: repeat(6, 1fr);
            align-items: end;
        }
        #add-breeding-horse-form .form-grid {
            grid-template-columns: repeat(4, 1fr);
            align-items: end;
        }
        #add-bred-horse-form .form-grid {
            grid-template-columns: repeat(4, 1fr);
            align-items: end;
        }
        #add-augment-form .form-grid {
            grid-template-columns: 2fr 1fr auto; /* Keep this specific layout */
            align-items: end;
        }

        /* --- Responsive Design --- */

        /* Medium Screens (Tablets, smaller laptops) */
        @media (max-width: 992px) {
            #add-horse-form .form-grid {
                grid-template-columns: repeat(3, 1fr); /* Adjust to 3 columns */
            }
            #add-race-form .form-grid {
                grid-template-columns: repeat(3, 1fr); /* Adjust to 3 columns */
            }
            #add-breeding-horse-form .form-grid,
            #add-bred-horse-form .form-grid {
                grid-template-columns: repeat(2, 1fr); /* Adjust to 2 columns */
            }
            #add-augment-form .form-grid {
                grid-template-columns: 1fr; /* Stack augment fields */
                gap: 15px;
            }
            #add-augment-form .form-grid div:last-child {
                justify-self: start; /* Align button to start */
            }
            #augments-list ul {
                 column-count: 2; /* Use 2 columns for augments list */
            }
        }

        /* Small Screens (Phones) */
        @media (max-width: 600px) {
            body {
                padding: 15px; /* Reduce body padding */
            }
            .section {
                padding: 15px; /* Reduce section padding */
            }
            h1 { font-size: 1.8em; }
            h2 { font-size: 1.4em; }
            h3 { font-size: 1.2em; }

            /* Stack all form grids to 1 column */
            .form-grid {
                grid-template-columns: 1fr !important; /* Override specific form grids */
            }
            #add-augment-form .form-grid {
                 grid-template-columns: 1fr !important; /* Ensure override */
            }
            #augments-list ul {
                column-count: 1; /* Use 1 column for augments list */
            }
            .tab-button {
                padding: 8px 12px; /* Smaller tab buttons */
                font-size: 0.9em;
            }
            .modal-content {
                 width: 90%; /* Wider modal on small screens */
                 margin: 5% auto;
                 padding: 20px;
            }
            /* Ensure table scroll containers work */
            div[style*="overflow-x:auto"] {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch; /* Smoother scrolling on iOS */
            }
        }

        /* Content Wrapper for constraining width */
        .content-wrapper {
            max-width: 1000px; /* Max width for the content */
            margin-left: 0; /* Align to left */
            margin-right: 0; /* Override potential inherited auto */
        }

        /* Control Name column width */
        #horses-table th:nth-child(1), /* Name */
        #horses-table td:nth-child(1) {
             /* Remove min-width to allow more flexibility with table-layout:fixed */
             max-width: 180px; /* Further reduce max width */
             overflow: hidden; /* Needed for text-overflow */
             text-overflow: ellipsis; /* Add ... for long names */
             white-space: nowrap; /* Prevent wrapping */
        }

        /* --- Breeding Tab Table Styles --- */

        /* Add space above breeding history title */
        #add-bred-horse-form + h3 {
            margin-top: 2.5em; /* Adjust as needed */
        }

        /* Registered Breeding Horses Table */
        #breeding-horses-table {
            table-layout: fixed;
            width: 100%;
        }
        #breeding-horses-table th:nth-child(1), /* Name */
        #breeding-horses-table td:nth-child(1) {
            min-width: 150px;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        #breeding-horses-table th:nth-child(3), /* Gender */
        #breeding-horses-table td:nth-child(3) {
            width: 80px;
            text-align: center;
        }
        #breeding-horses-table th:nth-child(4), /* Stars */
        #breeding-horses-table td:nth-child(4) {
            width: 190px; /* Increased width for combined stars */
            text-align: center;
        }
        #breeding-horses-table th:nth-child(5), /* Actions */
        #breeding-horses-table td:nth-child(5) {
            width: 120px; /* Increased width for 3 buttons */
            text-align: center;
        }

        /* Bred Horse History Table */
        #bred-horses-table {
            table-layout: fixed;
            width: 100%;
        }
        #bred-horses-table th {
            text-align: center; /* Center all headers in this table */
        }
        #bred-horses-table th:nth-child(1), /* Bred Date */
        #bred-horses-table td:nth-child(1) {
            width: 100px;
            text-align: center;
        }
        #bred-horses-table th:nth-child(2), /* Name */
        #bred-horses-table td:nth-child(2) {
            min-width: 120px;
            max-width: 220px; /* Reduced max-width */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        #bred-horses-table th:nth-child(3), /* Bloodline */
        #bred-horses-table td:nth-child(3) {
            width: 100px;
            text-align: center;
        }
        #bred-horses-table th:nth-child(4), /* Gender */
        #bred-horses-table td:nth-child(4) {
            width: 80px;
            text-align: center;
        }
        #bred-horses-table th:nth-child(5), /* Sire */
        #bred-horses-table td:nth-child(5),
        #bred-horses-table th:nth-child(6) /* Dam */
        #bred-horses-table td:nth-child(6) {
             width: 220px; /* Increased width */
              overflow: hidden; /* May need text-overflow if parent names get long */
              text-overflow: ellipsis;
              white-space: nowrap;
        }
        #bred-horses-table th:nth-child(7), /* Overall */
        #bred-horses-table td:nth-child(7),
        #bred-horses-table th:nth-child(8), /* Speed */
        #bred-horses-table td:nth-child(8),
        #bred-horses-table th:nth-child(9), /* Sprint */
        #bred-horses-table td:nth-child(9),
        #bred-horses-table th:nth-child(10) /* Endurance */
        #bred-horses-table td:nth-child(10) {
            width: 75px; /* Slightly increased width */
            text-align: center;
        }
        #bred-horses-table th:nth-child(11), /* Stud Fee */
        #bred-horses-table td:nth-child(11) {
            width: 80px;
            text-align: right; /* Align currency right */
        }
        #bred-horses-table th:nth-child(12), /* Actions */
        #bred-horses-table td:nth-child(12) {
            width: 80px;
            text-align: center;
        }

        /* --- Race History Table Styles --- */
        #races-table {
            table-layout: fixed;
            width: 100%; /* Allow race history to use full width if needed */
            max-width: 1300px; /* But cap it */
            margin-top: 20px;
        }
        #races-table th:nth-child(9), /* Actions */
        #races-table td:nth-child(9) {
            width: 80px; /* Explicit width for 2 buttons */
            text-align: center;
        }

        /* New CSS for Net / ROI column */
        #horses-table th:nth-child(8), /* Net / ROI */
        #horses-table td:nth-child(8) {
            width: 90px;
            text-align: center;
        }
        
        #horses-table th:nth-child(9), /* Win % (shifted) */
        #horses-table td:nth-child(9) {
            width: 70px;
            text-align: center;
        }

        /* --- Pagination Styles --- */
        .pagination-button {
            padding: 6px 12px; /* Smaller padding */
            font-size: 0.9em;
            height: auto; /* Override standard button height */
            min-width: 80px;
        }
        .pagination-button:disabled {
            background-color: var(--input-bg);
            color: var(--text-muted-color);
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Enhanced pagination controls alignment */
        .pagination-controls {
            margin-top: 15px;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .pagination-controls select,
        .pagination-controls button,
        .pagination-controls span {
            height: 32px;
            line-height: 32px;
            display: inline-flex;
            align-items: center;
        }

        .pagination-controls select,
        .pagination-select {
            padding-top: 0;
            padding-bottom: 0;
            text-align: center; /* Center the text */
            padding-left: 8px; /* Adjust padding to center visually */
            padding-right: 18px; /* Add extra space for the dropdown arrow */
            height: 32px; /* Ensure consistent height */
        }

        .pagination-controls label {
            margin-bottom: 0;
            display: inline-flex;
            align-items: center;
            height: 32px;
        }

        .pagination-controls div {
            display: inline-flex;
            align-items: center;
            height: 32px;
        }

        .pagination-controls span[id$='-page-info'] {
            margin: 0 5px;
        }

        /* --- Filter Controls --- */
        .filter-controls {
            display: grid;
            grid-template-columns: repeat(5, minmax(120px, 180px)); /* 5 columns with min/max width */
            grid-gap: 10px;
            margin-bottom: 15px;
            max-width: 100%; /* Allow full width */
            justify-content: start; /* Align grid to the start */
        }

        .filter-item {
            padding: 8px 10px;
            height: 38px;
            box-sizing: border-box;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-size: 0.9em;
            width: 100%; /* Take full width of grid cell */
            max-width: 180px; /* But no wider than this */
        }

        .filter-item:focus {
             border-color: var(--accent-color);
             box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
             outline: none;
        }

        /* Specific widths */
        #horse-search-input {
            flex-grow: 1; /* Allow search to take more space */
            min-width: 180px;
        }

        .filter-item-small { /* Class for smaller inputs like MMR range */
            width: 100px;
        }

        /* --- Augment Analysis Per Horse (Racing Tab) --- */
        #augment-analysis-content table {
            table-layout: fixed; /* Help control widths */
            width: 100%; /* Allow table to use space */
            max-width: 800px; /* INCREASED max width */
            margin-bottom: 20px; /* Space between horse tables */
        }
        #augment-analysis-content th,
        #augment-analysis-content td {
            text-align: center; /* Center most columns */
        }
        #augment-analysis-content th:nth-child(1),
        #augment-analysis-content td:nth-child(1) { /* Augment Combo */
            text-align: left;
            width: auto; /* Let this column take remaining space */
            /* REMOVED overflow, text-overflow, white-space */
        }
        #augment-analysis-content th:nth-child(2), /* Races */
        #augment-analysis-content td:nth-child(2) {
            width: 70px;
        }
        #augment-analysis-content th:nth-child(3), /* Win % */
        #augment-analysis-content td:nth-child(3) {
            width: 80px;
        }
        #augment-analysis-content th:nth-child(4), /* Avg Place */
        #augment-analysis-content td:nth-child(4) {
            width: 80px;
        }
        #augment-analysis-content th:nth-child(5), /* Avg Odds */
        #augment-analysis-content td:nth-child(5) {
            width: 80px;
        }

        /* --- Analysis Tab Table Styles --- */
        #bloodline-analysis-table,
        #individual-augment-table,
        #augment-pair-table,
        #augment-triple-table {
            table-layout: fixed;
            width: 100%;
            max-width: 900px; /* Increased Max width for analysis tables */
            margin-bottom: 30px; /* Space below tables */
        }

        /* --- Shared Analysis Table Column Styles (Excluding Bloodline) --- */
        #individual-augment-table th:not(:nth-child(1)):not(:nth-child(2)),
        #individual-augment-table td:not(:nth-child(1)):not(:nth-child(2)),
        #augment-pair-table th:not(:nth-child(1)),
        #augment-pair-table td:not(:nth-child(1)),
        #augment-triple-table th:not(:nth-child(1)),
        #augment-triple-table td:not(:nth-child(1)) {
            width: 80px; /* Compact width for stats columns */
            text-align: center;
        }

        /* --- Individual Augment Table Specifics --- */
        #individual-augment-table th:nth-child(1),
        #individual-augment-table td:nth-child(1) { /* Augment Name */
            width: 250px; /* Wider column */
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #individual-augment-table th:nth-child(2),
        #individual-augment-table td:nth-child(2) { /* Type */
            width: 70px;
            text-align: center;
        }

        /* --- Augment Pair Table Specifics --- */
        #augment-pair-table th:nth-child(1),
        #augment-pair-table td:nth-child(1) { /* Augment Pair */
            width: 350px; /* Wider column */
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- Triple Augment Table Specifics --- */
        #augment-triple-table th:nth-child(1),
        #augment-triple-table td:nth-child(1) { /* Augment Combination */
            width: 400px; /* Wider column */
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Column Widths for Bloodline Table */
        #bloodline-analysis-table {
             max-width: 600px; /* Keep bloodline table narrower */
        }
        #bloodline-analysis-table th:nth-child(1),
        #bloodline-analysis-table td:nth-child(1) { /* Bloodline */
            width: auto;
            text-align: left;
        }
        #bloodline-analysis-table th:nth-child(2),
        #bloodline-analysis-table td:nth-child(2) { /* Races */
            width: 80px;
            text-align: center;
        }
        #bloodline-analysis-table th:nth-child(3),
        #bloodline-analysis-table td:nth-child(3) { /* Win % */
            width: 80px;
            text-align: center;
        }
        #bloodline-analysis-table th:nth-child(4),
        #bloodline-analysis-table td:nth-child(4) { /* Avg Place */
            width: 100px;
            text-align: center;
        }
        #bloodline-analysis-table th:nth-child(5),
        #bloodline-analysis-table td:nth-child(5) { /* Avg Odds */
            width: 100px;
            text-align: center;
        }

        /* --- Augment Analysis Per Horse (Racing Tab) --- */

        /* --- Analysis Tab Table Styles --- */
        #bloodline-analysis-table,
        #individual-augment-table,
        #augment-pair-table,
        #augment-triple-table {
            table-layout: fixed;
            width: 100%;
            max-width: 600px; /* Max width for analysis tables */
            margin-bottom: 30px; /* Space below tables */
        }

        /* Column Widths for Bloodline Table */
        #bloodline-analysis-table th:nth-child(1),
        #bloodline-analysis-table td:nth-child(1) { /* Bloodline */
            width: auto;
            text-align: left;
        }
        #bloodline-analysis-table th:nth-child(2),
        #bloodline-analysis-table td:nth-child(2) { /* Races */
            width: 80px;
            text-align: center;
        }
        #bloodline-analysis-table th:nth-child(3),
        #bloodline-analysis-table td:nth-child(3) { /* Win % */
            width: 80px;
            text-align: center;
        }
        #bloodline-analysis-table th:nth-child(4),
        #bloodline-analysis-table td:nth-child(4) { /* Avg Place */
            width: 100px;
            text-align: center;
        }
        #bloodline-analysis-table th:nth-child(5),
        #bloodline-analysis-table td:nth-child(5) { /* Avg Odds */
            width: 100px;
            text-align: center;
        }

        /* --- Analysis Tab Filter Alignment --- */
        .analysis-filter-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        /* Reset all special positioning */
        .analysis-filter-controls > div,
        .analysis-filter-controls label,
        .analysis-filter-controls select,
        .analysis-filter-controls input,
        .analysis-filter-controls button {
            position: static;
            top: auto;
            margin: 0;
            vertical-align: middle;
        }

        /* Create a special class just for the button to force alignment */
        #augment-analysis-refresh {
            /* CSS technique that's more reliable than positioning */
            transform: translateY(4px); /* Increased to 4px to move it lower */
            display: inline-block;
            margin: 0;
            line-height: 32px;
            height: 32px;
            padding: 0 20px;
            /* Remove any other positioning that might interfere */
            position: static;
            top: auto;
            bottom: auto;
            vertical-align: baseline;
        }

        /* Remove any specific adjustments from previous attempts */
        #augment-analysis-bloodline-filter,
        #augment-analysis-min-races {
            box-sizing: border-box;
            height: 32px;
        }

        .analysis-filter-controls label {
            margin-right: 10px;
            margin-bottom: 0;
            display: inline-flex;
            align-items: center; /* Vertically center label text */
            height: 32px; /* Match control height */
        }

        /* Specific adjustments for the bloodline select */
        #augment-analysis-bloodline-filter.pagination-select {
            padding: 4px 18px 4px 8px; /* top/bottom 4px, keep existing L/R */
            text-align: left; /* Override pagination center align */
        }

        /* Specific adjustments for the min races input */
        #augment-analysis-min-races.filter-item {
            padding: 4px 10px; /* Match other inputs */
            height: 32px; /* Override the default .filter-item height */
        }

        /* Refresh button specific styles - ensure consistency */
        .analysis-filter-controls button,
        #augment-analysis-refresh.button {
            padding: 0 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 32px; /* Consistent height */
            line-height: 1; /* Control text alignment */
            margin: 0;
            position: relative; /* Allow for small adjustments */
            top: 1px; /* Slight downward adjustment to match other elements */
        }

        /* Ensure all elements in the filter row have the same visual grouping */
        #augment-analysis-bloodline-filter,
        #augment-analysis-min-races,
        #augment-analysis-refresh {
            margin-top: 0;
            margin-bottom: 0;
            vertical-align: middle;
        }

        /* Column Widths for Bloodline Table */
        #bloodline-analysis-table th:nth-child(1),
        #bloodline-analysis-table td:nth-child(1) { /* Bloodline */
            width: auto;
            text-align: left;
        }
        #bloodline-analysis-table th:nth-child(2),
        #bloodline-analysis-table td:nth-child(2) { /* Races */
            width: 80px;
            text-align: center;
        }
        #bloodline-analysis-table th:nth-child(3),
        #bloodline-analysis-table td:nth-child(3) { /* Win % */
            width: 80px;
            text-align: center;
        }
        #bloodline-analysis-table th:nth-child(4),
        #bloodline-analysis-table td:nth-child(4) { /* Avg Place */
            width: 100px;
            text-align: center;
        }
        #bloodline-analysis-table th:nth-child(5),
        #bloodline-analysis-table td:nth-child(5) { /* Avg Odds */
            width: 100px;
            text-align: center;
        }

        /* Create a completely new container for perfect alignment */
        .analysis-filter-row {
            display: flex;
            flex-direction: row;
            align-items: center; /* Vertically align all items */
            gap: 15px;
            margin-bottom: 20px;
        }

        .analysis-filter-item {
            display: flex;
            align-items: center;
        }

        .analysis-filter-item label {
            margin-right: 10px;
            margin-bottom: 0;
        }

        /* Style the button specifically */
        #augment-analysis-refresh {
            height: 32px;
            padding: 0 20px;
            margin: 0;
            /* Override button styles */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            /* Move button up by 1px */
            transform: translateY(-1px);
        }

        /* Match heights of all interactive elements */
        .analysis-filter-row select,
        .analysis-filter-row input,
        .analysis-filter-row button {
            height: 32px;
            box-sizing: border-box;
        }

    </style>
</head>
<body>

    <h1>Zed Champions Tracker</h1>

    <!-- Tab Navigation -->
    <div id="tab-buttons">
        <button class="tab-button active" data-tab="racing">Racing</button>
        <button class="tab-button" data-tab="breeding">Breeding</button>
        <button class="tab-button" data-tab="augments">Augments List</button>
        <button class="tab-button" data-tab="analysis">Analysis</button>
        <button class="tab-button" data-tab="stats">Overall Stats</button>
        <button class="tab-button" data-tab="settings">Settings</button>
    </div>

    <!-- Tab Content -->
    <div id="tab-content">

        <!-- Racing Tab Content -->
        <div id="tab-content-racing" class="tab-content active">
            <!-- Section for Managing Racing Horses -->
    <div class="section" id="horses-section">
                <h2>Racing Horses</h2>
                <div class="content-wrapper">
                    <h3>Add New Racing Horse</h3>
        <form id="add-horse-form">
            <div class="form-grid">
                <div>
                    <label for="horse-name">Name:</label>
                    <input type="text" id="horse-name" required>
                </div>
                <div>
                    <label for="horse-bloodline">Bloodline:</label>
                    <select id="horse-bloodline" required>
                        <option value="">--Select--</option>
                        <option value="Nakamoto">Nakamoto</option>
                                    <option value="Szabo">Szabo</option>
                                    <option value="Finney">Finney</option>
                        <option value="Buterin">Buterin</option>
                    </select>
                </div>
                <div>
                    <label for="horse-gender">Gender:</label>
                    <select id="horse-gender" required>
                         <option value="">--Select--</option>
                        <option value="Female">Female</option>
                        <option value="Male">Male</option>
                    </select>
                </div>
                <div>
                                <label for="horse-stars">Overall Stars:</label>
                                <input type="number" id="horse-stars" step="0.1" min="1" required>
                </div>
                 <div>
                    <label for="horse-zed-balance">Initial $ZED Balance:</label>
                    <input type="number" id="horse-zed-balance" step="any" value="0" required>
                </div>
                 <div>
                    <label for="horse-mm-rating">Initial Matchmaking Rating:</label>
                    <input type="number" id="horse-mm-rating" step="1" value="1000" required>
                </div>
                            <div>
                                <label for="horse-speed-stars">Speed Stars:</label>
                                <input type="number" id="horse-speed-stars" step="0.1" min="0" placeholder="Optional (Enter later)">
            </div>
                            <div>
                                <label for="horse-sprint-stars">Sprint Stars:</label>
                                <input type="number" id="horse-sprint-stars" step="0.1" min="0" placeholder="Optional (Enter later)">
                            </div>
                            <div>
                                <label for="horse-endurance-stars">Endurance Stars:</label>
                                <input type="number" id="horse-endurance-stars" step="0.1" min="0" placeholder="Optional (Enter later)">
                            </div>
                            <div>
                                <button type="submit">Add Racing Horse</button>
                            </div>
                        </div>
        </form>
                </div>

                <h3>Registered Racing Horses</h3>
                <!-- Simplified Filter Controls -->
                <div class="filter-controls">
                    <select id="horse-filter-bloodline" class="filter-item">
                        <option value="">All Bloodlines</option>
                        <option value="Nakamoto">Nakamoto</option>
                        <option value="Szabo">Szabo</option>
                        <option value="Finney">Finney</option>
                        <option value="Buterin">Buterin</option>
                    </select>
                    <select id="horse-filter-gender" class="filter-item">
                        <option value="">All Genders</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                    <input type="number" step="0.1" id="horse-filter-min-stars" placeholder="Min Overall" class="filter-item">
                    <input type="number" step="0.1" id="horse-filter-max-stars" placeholder="Max Overall" class="filter-item">
                    <input type="number" step="0.1" id="horse-filter-min-speed" placeholder="Min Speed" class="filter-item">
                    <input type="number" step="0.1" id="horse-filter-max-speed" placeholder="Max Speed" class="filter-item">
                    <input type="number" step="0.1" id="horse-filter-min-sprint" placeholder="Min Sprint" class="filter-item">
                    <input type="number" step="0.1" id="horse-filter-max-sprint" placeholder="Max Sprint" class="filter-item">
                    <input type="number" step="0.1" id="horse-filter-min-endurance" placeholder="Min Endur" class="filter-item">
                    <input type="number" step="0.1" id="horse-filter-max-endurance" placeholder="Max Endur" class="filter-item">
                </div>

                <div style="overflow-x:auto;">
            <table id="horses-table">
                <thead>
                    <tr>
                                <th data-sort-key="name">Name</th>
                                <th data-sort-key="bloodline">Bloodline</th>
                                <th data-sort-key="gender">Gender</th>
                                <th data-sort-key="stars">Stars (O/Sp/Sr/E)</th>
                                <th data-sort-key="mmr">MMR</th>
                                <th data-sort-key="zed">$ZED Bal</th>
                                <th data-sort-key="wins">W-P-S</th> <!-- Sorting by Wins -->
                                <th data-sort-key="netProfit">Net / ROI</th> <!-- NEW COLUMN -->
                                <th data-sort-key="winRate">Win %</th>
                                <th data-sort-key="races">Races</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="horses-table-body">
                    <!-- Horse data populated by JS -->
                </tbody>
            </table>
        </div>
        <!-- Pagination Controls for Horses Table -->
        <div id="horses-pagination-controls" class="pagination-controls">
             <div style="display: inline-flex; align-items: center; gap: 5px;"> <!-- Group label/select -->
                <label for="horses-items-per-page" style="margin-right: 5px;">Show:</label>
                <select id="horses-items-per-page" class="pagination-select">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
    </div>
            <!-- Nav elements are now direct children -->
            <button id="horses-prev-page" class="button pagination-button">&lt; Previous</button>
            <span id="horses-page-info">Page 1 of 1</span>
            <button id="horses-next-page" class="button pagination-button">Next &gt;</button>
            </div>
    </div>

    <!-- Section for Adding Race Results -->
    <div class="section" id="races-section">
        <h2>Record Race Result</h2>
                <div class="content-wrapper">
                    <h3>Record New Race</h3>
        <form id="add-race-form">
             <div class="form-grid">
                 <div>
                    <label for="race-horse">Select Horse:</label>
                    <select id="race-horse" required>
                                    <option value="">--Select Racing Horse--</option>
                        <!-- Options populated by JS -->
                    </select>
                 </div>
                 <div>
                                <label for="race-position">Place:</label>
                    <input type="number" id="race-position" min="1" step="1" required>
                </div>
                 <div>
                                <label for="race-odds">Odds:</label>
                    <input type="number" id="race-odds" min="1" step="any" required>
                 </div>
                 <div>
                                <label for="race-finish-time">Time:</label>
                                <input type="number" id="race-finish-time" step="any" min="0" placeholder="Seconds">
                 </div>
                 <div>
                    <label for="race-zed-change">$ZED Won/Lost:</label>
                                <input type="number" id="race-zed-change" step="any" required placeholder="e.g., 1200, -350">
                 </div>
                 <div>
                                <label for="race-rating-change">MM Change:</label>
                                <input type="number" id="race-rating-change" step="1" placeholder="Matchmaking Change (e.g., 15, -8)"> <!-- Updated placeholder -->
                 </div>
                 <div>
                     <label for="race-cpu-augment">CPU Augment Used:</label>
                     <select id="race-cpu-augment" required>
                         <option value="None">None</option>
                         <!-- Options populated by JS from known list -->
                     </select>
                 </div>
                  <div>
                     <label for="race-ram-augment">RAM Augment Used:</label>
                     <select id="race-ram-augment" required>
                          <option value="None">None</option>
                          <!-- Options populated by JS from known list -->
                     </select>
                 </div>
                  <div>
                     <label for="race-hydraulic-augment">Hydraulic Augment Used:</label>
                     <select id="race-hydraulic-augment" required>
                          <option value="None">None</option>
                          <!-- Options populated by JS from known list -->
                     </select>
                 </div>
                            <div> <!-- Move button into the grid -->
            <button type="submit">Record Race</button>
                            </div>
                        </div>
        </form>
                </div>

         <h3>Race History</h3>
          <div style="overflow-x:auto;">
             <table id="races-table">
                 <thead>
                     <tr>
                         <th>Date</th>
                         <th>Horse</th>
                         <th>Pos</th>
                         <th>Odds</th>
                         <th>Time</th>
                         <th>ZED +/-</th>
                                <th>MM +/-</th>
                         <th>Augs (C/R/H)</th>
                         <th>Actions</th>
                     </tr>
                 </thead>
                 <tbody id="races-table-body">
                     <!-- Race results populated by JS -->
                 </tbody>
             </table>
         </div>
         <!-- Pagination Controls for Races Table -->
        <div id="races-pagination-controls" class="pagination-controls">
            <div style="display: inline-flex; align-items: center; gap: 5px;">
                <label for="races-items-per-page" style="margin-right: 5px;">Show:</label>
                <select id="races-items-per-page" class="pagination-select">
                    <option value="10">10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <button id="races-prev-page" class="button pagination-button">&lt; Previous</button>
            <span id="races-page-info">Page 1 of 1</span>
            <button id="races-next-page" class="button pagination-button">Next &gt;</button>
         </div>
    </div>

            <!-- Section for Augment Performance Analysis -->
            <div class="section" id="augment-analysis-section">
                <h2>Augment Performance Analysis</h2>
                <p>Shows performance statistics grouped by unique augment combinations for each racing horse.</p>
                
                <!-- Horse Filter for Augment Analysis -->
                <div style="margin-bottom: 15px; display: flex; align-items: center;">
                    <label for="augment-analysis-horse-filter" style="margin-right: 10px;">Filter by Horse:</label>
                    <select id="augment-analysis-horse-filter" style="width: 180px; max-width: 250px; padding: 8px;" class="pagination-select">
                        <option value="">All Horses</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>
                
                <div id="augment-analysis-content">
                    <!-- Analysis tables will be generated here by JS -->
                </div>
            </div>
        </div>

        <!-- Breeding Tab Content -->
        <div id="tab-content-breeding" class="tab-content">
            <!-- Section for Retired Horses -->
            <div class="section" id="breeding-horses-section"> <!-- Renamed ID -->
                <div class="content-wrapper"> <!-- Wrapper Start -->
                    <h2>Breeding Horses</h2> <!-- Renamed Title -->
 
                    <form id="add-breeding-horse-form">
                        <h3>Add New Breeding Horse</h3>
                        <div class="form-grid">
                            <div>
                                <label for="breeding-horse-name">Name:</label>
                                <input type="text" id="breeding-horse-name" required>
                            </div>
                             <div>
                                <label for="breeding-horse-bloodline">Bloodline:</label>
                                <select id="breeding-horse-bloodline" required>
                                    <option value="">--Select--</option>
                                    <option value="Nakamoto">Nakamoto</option>
                                    <option value="Szabo">Szabo</option>
                                    <option value="Finney">Finney</option>
                                    <option value="Buterin">Buterin</option>
                                </select>
                            </div>
                            <div>
                                <label for="breeding-horse-gender">Gender:</label>
                                <select id="breeding-horse-gender" required>
                                     <option value="">--Select--</option>
                                    <option value="Female">Female</option>
                                    <option value="Male">Male</option>
                                </select>
                            </div>
                             <div>
                                <label for="breeding-horse-stars">Overall Stars:</label>
                                 <input type="number" id="breeding-horse-stars" step="0.1" min="1" placeholder="Optional">
                            </div>
                             <div>
                                  <label for="breeding-horse-speed-stars">Speed Stars:</label>
                                  <input type="number" id="breeding-horse-speed-stars" step="0.1" min="0" placeholder="Optional">
                              </div>
                              <div>
                                  <label for="breeding-horse-sprint-stars">Sprint Stars:</label>
                                  <input type="number" id="breeding-horse-sprint-stars" step="0.1" min="0" placeholder="Optional">
                              </div>
                              <div>
                                  <label for="breeding-horse-endurance-stars">Endurance Stars:</label>
                                  <input type="number" id="breeding-horse-endurance-stars" step="0.1" min="0" placeholder="Optional">
                              </div>
                              <div>
                                  <button type="submit">Add Breeding Horse</button>
                              </div>
                        </div>
                    </form>

                    <hr style="margin: 2em 0; border-color: var(--border-color);"> <!-- Separator -->

                    <h3>Registered Breeding Horses</h3> <!-- Updated Title -->
                    <div style="overflow-x:auto;">
                        <table id="breeding-horses-table"> <!-- Renamed ID -->
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Bloodline</th>
                                    <th>Gender</th>
                                    <th>Stars (O/Sp/Sr/E)</th> <!-- Combined Stars -->
                                    <!-- Removed racing stats columns -->
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="breeding-horses-table-body"> <!-- Renamed ID -->
                                <!-- Retired horse data populated by JS -->
                            </tbody>
                        </table>
                    </div>
                     <!-- Pagination Controls for Breeding Horses Table -->
                    <div id="breeding-horses-pagination-controls" class="pagination-controls">
                        <div style="display: inline-flex; align-items: center; gap: 5px;">
                            <label for="breeding-horses-items-per-page" style="margin-right: 5px;">Show:</label>
                            <select id="breeding-horses-items-per-page" class="pagination-select">
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        <button id="breeding-horses-prev-page" class="button pagination-button">&lt; Previous</button>
                        <span id="breeding-horses-page-info">Page 1 of 1</span>
                        <button id="breeding-horses-next-page" class="button pagination-button">Next &gt;</button>
                    </div>
 
                </div> <!-- Wrapper End -->
            </div>

            <!-- Section for Recording Bred Horses (Stays the same) -->
            <div class="section" id="bred-horses-section">
                <div class="content-wrapper"> <!-- Wrapper Start -->
                 <h2>Bred Horses</h2>
 
                 <form id="add-bred-horse-form">
                     <h3>Record New Bred Horse</h3>
                     <div class="form-grid">
                         <div>
                             <label for="bred-name">New Horse Name:</label>
                             <input type="text" id="bred-name" required>
                         </div>
                         <div>
                             <label for="bred-bloodline">Bloodline:</label>
                             <select id="bred-bloodline" required>
                                 <option value="">--Select--</option>
                                 <option value="Nakamoto">Nakamoto</option>
                                 <option value="Szabo">Szabo</option>
                                 <option value="Finney">Finney</option>
                                 <option value="Buterin">Buterin</option>
                             </select>
                         </div>
                         <div>
                             <label for="bred-gender">Gender:</label>
                             <select id="bred-gender" required>
                                  <option value="">--Select--</option>
                                 <option value="Female">Female</option>
                                 <option value="Male">Male</option>
                             </select>
                         </div>
                          <div>
                             <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px;">
                                 <label for="bred-sire" style="margin-bottom: 0;">Sire (Father):</label>
                                 <label style="display: inline-flex; align-items: center; cursor: pointer; font-size: 0.9em;">
                                     <input type="checkbox" id="use-external-sire" style="margin-right: 5px;">
                                     External Sire
                                 </label>
                             </div>
                              <select id="bred-sire" required>
                                  <option value="">--Select Male Parent--</option>
                                  <!-- Male horses populated by JS -->
                              </select>
                              <div id="sire-stats" class="parent-stats"></div>
                          </div>
                          <div class="external-sire-fields" style="display: none;"> <!-- Initially hidden -->
                             <label for="external-sire-name">External Sire Name:</label>
                             <input type="text" id="external-sire-name">
                         </div>
                         <div class="external-sire-fields" style="display: none;"> <!-- Initially hidden -->
                             <label for="external-sire-bloodline">External Sire Bloodline:</label>
                             <select id="external-sire-bloodline">
                                 <option value="">--Select--</option>
                                 <option value="Nakamoto">Nakamoto</option>
                                 <option value="Szabo">Szabo</option>
                                 <option value="Finney">Finney</option>
                                 <option value="Buterin">Buterin</option>
                                 <option value="Unknown">Unknown</option>
                             </select>
                         </div>
                         <div class="external-sire-fields" style="display: none;">
                             <label for="external-sire-overall-stars">Ext. Sire Overall Stars:</label>
                             <input type="number" id="external-sire-overall-stars" step="0.1" min="1" placeholder="Optional">
                         </div>
                         <div class="external-sire-fields" style="display: none;">
                             <label for="external-sire-speed-stars">Ext. Sire Speed Stars:</label>
                             <input type="number" id="external-sire-speed-stars" step="0.1" min="0" placeholder="Optional">
                         </div>
                         <div class="external-sire-fields" style="display: none;">
                             <label for="external-sire-sprint-stars">Ext. Sire Sprint Stars:</label>
                             <input type="number" id="external-sire-sprint-stars" step="0.1" min="0" placeholder="Optional">
                         </div>
                         <div class="external-sire-fields" style="display: none;">
                             <label for="external-sire-endurance-stars">Ext. Sire Endurance Stars:</label>
                             <input type="number" id="external-sire-endurance-stars" step="0.1" min="0" placeholder="Optional">
                         </div>
                         <div>
                             <label for="bred-dam">Dam (Mother):</label>
                             <select id="bred-dam" required>
                                 <option value="">--Select Female Parent--</option>
                                 <!-- Female horses populated by JS -->
                             </select>
                              <div id="dam-stats" class="parent-stats"></div>
                         </div>
                         <div>
                             <label for="bred-date">Date Bred:</label>
                             <input type="date" id="bred-date">
                         </div>
                          <div>
                             <label for="bred-stud-fee">Stud Fee Paid:</label>
                             <input type="number" id="bred-stud-fee" step="any" value="0" required>
                          </div>
                           <div>
                              <label for="bred-overall-stars">Overall Stars:</label>
                              <input type="number" id="bred-overall-stars" step="0.1" min="1" placeholder="Optional">
                         </div>
                          <div>
                               <label for="bred-speed-stars">Speed Stars:</label>
                               <input type="number" id="bred-speed-stars" step="0.1" min="0" placeholder="Optional">
                           </div>
                           <div>
                               <label for="bred-sprint-stars">Sprint Stars:</label>
                               <input type="number" id="bred-sprint-stars" step="0.1" min="0" placeholder="Optional">
                           </div>
                           <div>
                               <label for="bred-endurance-stars">Endurance Stars:</label>
                               <input type="number" id="bred-endurance-stars" step="0.1" min="0" placeholder="Optional">
                           </div>
                           <div>
                               <button type="submit">Record Bred Horse</button>
                           </div>
                      </div>
                 </form>

                 </div> <!-- Wrapper End for Form -->
 
                 <!-- History Table Outside Wrapper -->
                 <h3>Bred Horse History</h3>
                 <div style="overflow-x:auto;">
                     <table id="bred-horses-table">
                         <thead>
                             <tr>
                                 <th>Bred Date</th>
                                 <th>Name</th>
                                 <th>Bloodline</th>
                                 <th>Gender</th>
                                 <th>Sire</th>
                                 <th>Dam</th>
                                 <th>Overall</th>
                                 <th>Speed</th>
                                 <th>Sprint</th>
                                 <th>Endurance</th>
                                 <th>Stud Fee</th>
                                 <th>Actions</th>
                             </tr>
                         </thead>
                         <tbody id="bred-horses-table-body">
                             <!-- Bred horse history populated by JS -->
                         </tbody>
                     </table>
                 </div>
                 <!-- Pagination Controls for Bred History Table -->
                 <div id="bred-history-pagination-controls" class="pagination-controls">
                    <div style="display: inline-flex; align-items: center; gap: 5px;">
                        <label for="bred-history-items-per-page" style="margin-right: 5px;">Show:</label>
                        <select id="bred-history-items-per-page" class="pagination-select">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <button id="bred-history-prev-page" class="button pagination-button">&lt; Previous</button>
                    <span id="bred-history-page-info">Page 1 of 1</span>
                    <button id="bred-history-next-page" class="button pagination-button">Next &gt;</button>
                </div>
 
             </div>
         </div>

        <!-- Augments Tab Content -->
        <div id="tab-content-augments" class="tab-content">
            <div class="content-wrapper">
             <!-- Section for Augments -->
             <div class="section" id="augments-section">
                 <h2>Manage Augments</h2>
                 <p>Add or remove augments available in dropdowns.</p>

                 <!-- Add Augment Form -->
                 <form id="add-augment-form">
                     <h3>Add New Augment</h3>
                     <div class="form-grid">
                           <div>
                             <label for="augment-name" class="label-required">Augment Name:</label>
                             <input type="text" id="augment-name" required placeholder="e.g., Void C100">
                           </div>
                           <div>
                             <label for="augment-type" class="label-required">Type:</label>
                             <select id="augment-type" required>
                                 <option value="">--Select Type--</option>
                                 <option value="CPU">CPU</option>
                                 <option value="RAM">RAM</option>
                                 <option value="Hydraulic">Hydraulic</option>
                               </select>
                           </div>
                         <!-- Removed align-items: end from grid, using align-self on button's container if needed -->
                         <div> <!-- Removed align-self: end; -->
                             <button type="submit">Add Augment</button>
                     </div>
                     </div>
                 </form>
                  <hr style="margin: 2em 0; border-color: var(--border-color);">

                 <h3>Current Augments</h3>
                 <div class="form-grid">
                     <div>
                         <h3>CPU</h3>
                         <ul id="cpu-augment-list" class="augment-manage-list">
                             <!-- Populated by JS -->
                         </ul>
                     </div>
                     <div>
                         <h3>RAM</h3>
                         <ul id="ram-augment-list" class="augment-manage-list">
                              <!-- Populated by JS -->
                         </ul>
                     </div>
                      <div>
                         <h3>Hydraulic</h3>
                         <ul id="hydraulic-augment-list" class="augment-manage-list">
                             <!-- Populated by JS -->
                         </ul>
                      </div>
                 </div>
             </div>
             </div>
         </div> <!-- Close .content-wrapper -->

        <!-- Analysis Tab Content -->
        <div id="tab-content-analysis" class="tab-content">
            <div class="section" id="performance-by-bloodline-section">
                <h2>Performance by Bloodline</h2>
                <p>Average performance metrics broken down by bloodline.</p>
                
                <table id="bloodline-analysis-table">
                    <thead>
                        <tr>
                            <th>Bloodline</th>
                            <th>Races</th>
                            <th>Win %</th>
                            <th>Avg Place</th>
                            <th>Avg Odds</th>
                        </tr>
                    </thead>
                    <tbody id="bloodline-analysis-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>

            <div class="section" id="augment-analysis-section">
                <h2>Augment Performance Analysis</h2>
                
                <!-- Filters for augment analysis -->
                <div class="analysis-filter-row">
                    <div class="analysis-filter-item">
                        <label for="augment-analysis-bloodline-filter">Bloodline:</label>
                        <select id="augment-analysis-bloodline-filter" class="pagination-select" style="width: 150px;">
                            <option value="">All Bloodlines</option>
                            <option value="Nakamoto">Nakamoto</option>
                            <option value="Szabo">Szabo</option>
                            <option value="Finney">Finney</option>
                            <option value="Buterin">Buterin</option>
                        </select>
                    </div>
                    <div class="analysis-filter-item">
                        <label for="augment-analysis-min-races">Min Races:</label>
                        <input type="number" id="augment-analysis-min-races" class="filter-item" style="width: 80px;" value="5">
                    </div>
                    <div class="analysis-filter-item">
                        <button id="augment-analysis-refresh" class="button">Refresh Analysis</button>
                    </div>
                </div>
                
                <h3>Individual Augment Performance</h3>
                <div style="overflow-x: auto; margin-bottom: 30px;">
                    <table id="individual-augment-table">
                        <thead>
                            <tr>
                                <th>Augment</th>
                                <th>Type</th>
                                <th>Races</th>
                                <th>Win %</th>
                                <th>Avg Place</th>
                                <th>Avg Odds</th>
                            </tr>
                        </thead>
                        <tbody id="individual-augment-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
                
                <h3>Augment Pair Performance</h3>
                <div style="overflow-x: auto; margin-bottom: 30px;">
                    <table id="augment-pair-table">
                        <thead>
                            <tr>
                                <th>Augment Pair</th>
                                <th>Races</th>
                                <th>Win %</th>
                                <th>Avg Place</th>
                                <th>Avg Odds</th>
                            </tr>
                        </thead>
                        <tbody id="augment-pair-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
                
                <h3>Triple Augment Performance</h3>
                <div style="overflow-x: auto;">
                    <table id="augment-triple-table">
                        <thead>
                            <tr>
                                <th>Augment Combination</th>
                                <th>Races</th>
                                <th>Win %</th>
                                <th>Avg Place</th>
                                <th>Avg Odds</th>
                            </tr>
                        </thead>
                        <tbody id="augment-triple-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Stats Tab Content -->
        <div id="tab-content-stats" class="tab-content">
     <!-- Section for Displaying Overall Stats -->
     <div class="section" id="stats-section">
        <h2>Overall Statistics</h2>
        <div id="stats-content">
            <p>Total Races Recorded: <span id="total-races"></span></p>
            <p>Total $ZED Change (All Horses): <span id="total-zed-change"></span></p>
            <p>Total Retirement Earnings: <span id="total-retirement-earnings"></span></p>
            <p>Total Stud Fees Paid: <span id="total-stud-fees"></span></p>
            <!-- Add more overall stats if desired -->
                 </div>
        </div>
    </div>

        <!-- Settings Tab Content -->
        <div id="tab-content-settings" class="tab-content section">
            <h2>Data Management</h2>
            <div style="margin-top: 15px;">
                <button id="export-data-button" class="button">Export All Data</button>
                <p style="font-size: 0.9em; color: var(--text-muted-color); margin-top: 8px;">
                    Saves all horses, races, bred records, and augments to a JSON file as a backup.
                </p>
            </div>
            <hr style="margin: 2em 0; border-color: var(--border-color);"> <!-- Separator -->
            <div style="margin-top: 15px;">
                <button id="import-data-button" class="button">Import Data from Backup</button>
                <input type="file" id="import-file-input" accept=".json" style="display: none;">
                <p style="font-size: 0.9em; color: var(--text-muted-color); margin-top: 8px;">
                    Loads data from a previously exported JSON backup file.
                    <strong style="color: var(--error-color);">Warning: This will overwrite all current data in the tracker.</strong>
                </p>
            </div>
            <!-- Import functionality could be added here later -->
        </div>

     </div> <!-- End #tab-content -->
 
 
     <script>
        // --- Global State ---
        let horses = []; // Racing horses
        let races = [];
        let breedingHorses = [];
        let bredHorses = [];
        // Augment lists - managed dynamically
        let cpuAugments = [];
        let ramAugments = [];
        let hydraulicAugments = [];
        let totalRetirementEarnings = 0; // Will be loaded from localStorage
        let racingHorseSort = { key: 'name', direction: 'asc' }; // Initial sort state
        // Pagination State for Horses Table
        let horseTableCurrentPage = 1;
        let horseTableItemsPerPage = 10; // Default, will be loaded
        // Pagination State for Races Table
        let raceTableCurrentPage = 1;
        let raceTableItemsPerPage = 10; // Default, will be loaded
        // Pagination State for Breeding Horses Table
        let breedingHorseTableCurrentPage = 1;
        let breedingHorseTableItemsPerPage = 10; // Default, will be loaded
        // Pagination State for Bred History Table
        let bredHistoryTableCurrentPage = 1;
        let bredHistoryTableItemsPerPage = 10; // Default, will be loaded
        
        // Editing states
        let currentlyEditingHorse = null; // For editing a horse
        let currentlyEditingRace = null;  // For editing a race

        // Declare modal variables globally (scoped to the script)
        let modal, modalCloseBtn, modalTitle, modalStatsContent, modalAnalysisContent;

        // --- DOM Elements ---
        const addHorseForm = document.getElementById('add-horse-form');
        const horsesTableBody = document.getElementById('horses-table-body');
        const raceHorseSelect = document.getElementById('race-horse');
        const addRaceForm = document.getElementById('add-race-form');
        const racesTableBody = document.getElementById('races-table-body');
        const cpuAugmentSelect = document.getElementById('race-cpu-augment');
        const ramAugmentSelect = document.getElementById('race-ram-augment');
        const hydraulicAugmentSelect = document.getElementById('race-hydraulic-augment');
        const totalRacesSpan = document.getElementById('total-races');
        const totalZedChangeSpan = document.getElementById('total-zed-change');
        // Breeding Horse Elements
        const addBreedingHorseForm = document.getElementById('add-breeding-horse-form');
        const breedingStableTableBody = document.getElementById('breeding-horses-table-body'); // Use distinct name
        // Bred Horse Elements
        const addBredHorseForm = document.getElementById('add-bred-horse-form');
        const bredHorsesTableBody = document.getElementById('bred-horses-table-body');
        const sireSelect = document.getElementById('bred-sire');
        const damSelect = document.getElementById('bred-dam');
        const sireStatsDiv = document.getElementById('sire-stats');
        const damStatsDiv = document.getElementById('dam-stats');
        const useExternalSireCheckbox = document.getElementById('use-external-sire');
        const externalSireFields = document.querySelectorAll('.external-sire-fields');
        const externalSireNameInput = document.getElementById('external-sire-name');
        const externalSireBloodlineSelect = document.getElementById('external-sire-bloodline');

        // Tab Elements
        const tabButtonContainer = document.getElementById('tab-buttons');
        const tabContentContainer = document.getElementById('tab-content');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        // Augment Management Elements
        const addAugmentForm = document.getElementById('add-augment-form');
        const cpuAugmentList = document.getElementById('cpu-augment-list');
        const ramAugmentList = document.getElementById('ram-augment-list');
        const hydraulicAugmentList = document.getElementById('hydraulic-augment-list');

        // Stats Elements
        const totalRetirementEarningsSpan = document.getElementById('total-retirement-earnings');
        const totalStudFeesSpan = document.getElementById('total-stud-fees');

        // Filter/Search Elements
        const horseSearchInput = document.getElementById('horse-search-input');
        const horseFilterBloodline = document.getElementById('horse-filter-bloodline');
        const horseFilterGender = document.getElementById('horse-filter-gender');
        
        // Augment Analysis Filter
        const augmentAnalysisHorseFilter = document.getElementById('augment-analysis-horse-filter');
        
        // Star filter elements
        const horseFilterMinStars = document.getElementById('horse-filter-min-stars');
        const horseFilterMaxStars = document.getElementById('horse-filter-max-stars');
        const horseFilterMinSpeed = document.getElementById('horse-filter-min-speed');
        const horseFilterMaxSpeed = document.getElementById('horse-filter-max-speed');
        const horseFilterMinSprint = document.getElementById('horse-filter-min-sprint');
        const horseFilterMaxSprint = document.getElementById('horse-filter-max-sprint');
        const horseFilterMinEndurance = document.getElementById('horse-filter-min-endurance');
        const horseFilterMaxEndurance = document.getElementById('horse-filter-max-endurance');

        // Pagination Elements for Horses Table
        const horsesItemsPerPageSelect = document.getElementById('horses-items-per-page');
        const horsesPrevPageButton = document.getElementById('horses-prev-page');
        const horsesNextPageButton = document.getElementById('horses-next-page');
        const horsesPageInfoSpan = document.getElementById('horses-page-info');

        // Pagination Elements for Races Table
        const racesItemsPerPageSelect = document.getElementById('races-items-per-page');
        const racesPrevPageButton = document.getElementById('races-prev-page');
        const racesNextPageButton = document.getElementById('races-next-page');
        const racesPageInfoSpan = document.getElementById('races-page-info');

        // Pagination Elements for Breeding Horses Table
        const breedingHorsesItemsPerPageSelect = document.getElementById('breeding-horses-items-per-page');
        const breedingHorsesPrevPageButton = document.getElementById('breeding-horses-prev-page');
        const breedingHorsesNextPageButton = document.getElementById('breeding-horses-next-page');
        const breedingHorsesPageInfoSpan = document.getElementById('breeding-horses-page-info');

        // Pagination Elements for Bred History Table
        const bredHistoryItemsPerPageSelect = document.getElementById('bred-history-items-per-page');
        const bredHistoryPrevPageButton = document.getElementById('bred-history-prev-page');
        const bredHistoryNextPageButton = document.getElementById('bred-history-next-page');
        const bredHistoryPageInfoSpan = document.getElementById('bred-history-page-info');

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Tracker Initializing...");

            // Move DOM Element selections inside DOMContentLoaded to ensure elements exist
            // Assign elements to the globally declared variables
            modal = document.getElementById('horse-details-modal');
            modalCloseBtn = document.getElementById('modal-close-button');
            modalTitle = document.getElementById('modal-horse-name');
            modalStatsContent = document.getElementById('modal-stats-content');
            modalAnalysisContent = document.getElementById('modal-analysis-content');

            // Event listeners for modal (now safe to add)
            if (modalCloseBtn) {
                modalCloseBtn.onclick = hideHorseDetailsModal;
            }
            window.onclick = function(event) {
                if (event.target == modal) {
                    hideHorseDetailsModal();
                }
            }

            loadData(); // Load data FIRST
            populateAugmentDropdowns();
            populateAugmentAnalysisHorseFilter(); // Populate the augment analysis horse filter
            initializeTabs();
            renderHorsesTable(); // Renders active racing horses
            renderBreedingHorsesTable(); // Renamed function call
            renderRacesTable();
            renderBredHorsesTable();
            renderAugmentAnalysis();
            updateHorseDropdown(); // For race form (only racing horses)
            updateParentDropdowns(); // For bred form (all horses)
            updateOverallStats();
            setupEventListeners();
            console.log("Tracker Initialized.");
        });

        // --- Data Storage (localStorage) ---
        function loadData() {
            // Load main horses list first
            horses = JSON.parse(localStorage.getItem('zedTrackerHorses') || '[]');
            races = JSON.parse(localStorage.getItem('zedTrackerRaces') || '[]');
            bredHorses = JSON.parse(localStorage.getItem('zedTrackerBredHorses') || '[]');
            cpuAugments = JSON.parse(localStorage.getItem('zedTrackerCpuAugments') || '["Void C100", "Crimson C", "GX-Core C", "Darklight 100C", "Midnight 100C"]');
            ramAugments = JSON.parse(localStorage.getItem('zedTrackerRamAugments') || '["Void R100", "Crimson R", "GX-Core R", "Darklight 100R", "Midnight 100R"]');
            hydraulicAugments = JSON.parse(localStorage.getItem('zedTrackerHydraulicAugments') || '["Void H100", "Crimson H", "GX-Core H", "Darklight 100H", "Midnight 100H"]');
            totalRetirementEarnings = parseFloat(localStorage.getItem('zedTrackerRetirementEarnings') || '0');
            // Load items per page preference
            horseTableItemsPerPage = parseInt(localStorage.getItem('horseTableItemsPerPage') || '10', 10);
            raceTableItemsPerPage = parseInt(localStorage.getItem('raceTableItemsPerPage') || '10', 10); // Load races pref
            breedingHorseTableItemsPerPage = parseInt(localStorage.getItem('breedingHorseTableItemsPerPage') || '10', 10); // Load breeding pref
            bredHistoryTableItemsPerPage = parseInt(localStorage.getItem('bredHistoryTableItemsPerPage') || '10', 10); // Load bred history pref

            // --- Data Migration: Merge old breedingHorses into horses if exists --- //
            const oldBreedingHorsesData = localStorage.getItem('zedTrackerBreedingHorses');
            if (oldBreedingHorsesData) {
                console.log("Found old breeding horses data, attempting migration...");
                try {
                    const oldBreedingHorses = JSON.parse(oldBreedingHorsesData);
                    if (Array.isArray(oldBreedingHorses)) {
                        oldBreedingHorses.forEach(bh => {
                            // Check if ID already exists in main list
                            if (!horses.some(h => h.id === bh.id)) {
                                // Add status and add to main list
                                bh.status = 'retired';
                                // Ensure core fields exist, add optional if missing
                                bh.name = bh.name || 'Unknown';
                                bh.bloodline = bh.bloodline || 'Unknown';
                                bh.gender = bh.gender || 'Unknown';
                                bh.stars = bh.stars || 0;
                                bh.speedStars = bh.speedStars !== undefined ? bh.speedStars : null;
                                bh.sprintStars = bh.sprintStars !== undefined ? bh.sprintStars : null;
                                bh.enduranceStars = bh.enduranceStars !== undefined ? bh.enduranceStars : null;
                                // Racing stats should NOT be present on purely breeding horses
                                delete bh.initialZedBalance;
                                delete bh.initialMmRating;

                                horses.push(bh);
                                console.log(`Migrated breeding horse: ${bh.name}`);
                            } else {
                                console.warn(`Skipping migration for breeding horse ${bh.name} (ID: ${bh.id}) - ID already exists in main horses list.`);
                            }
                        });
                        // Attempt to remove the old key after migration
                        localStorage.removeItem('zedTrackerBreedingHorses');
                        console.log("Old breeding horses data removed after migration attempt.");
                         // Save the potentially updated horses list immediately
                         saveData();
                    }
                } catch (error) {
                    console.error("Error migrating old breeding horses data:", error);
                }
            }

            // Ensure all horses have a status & migrate old 'retired' to 'breeding'
            horses.forEach(horse => {
                if (!horse.status) {
                    console.warn(`Horse ${horse.name} missing status, defaulting to 'racing'.`);
                    horse.status = 'racing';
                } else if (horse.status === 'retired') {
                    console.log(`Migrating horse ${horse.name} status from 'retired' to 'breeding'.`);
                    horse.status = 'breeding'; // Migrate old status
                }
                // Ensure racing horses have initial stats defined (important for retirement calc)
                 if (horse.status === 'racing') {
                    if (horse.initialZedBalance === undefined) horse.initialZedBalance = 0;
                    if (horse.initialMmRating === undefined) horse.initialMmRating = 1000;
                }
            });

            console.log(`Loaded ${horses.length} total horses, ${races.length} races, ${bredHorses.length} bred horses.`);
            console.log(`Loaded ${cpuAugments.length} CPU, ${ramAugments.length} RAM, ${hydraulicAugments.length} Hydraulic augments.`);
        }

        function saveData() {
            localStorage.setItem('zedTrackerHorses', JSON.stringify(horses)); // Unified list
            localStorage.setItem('zedTrackerRaces', JSON.stringify(races));
            localStorage.setItem('zedTrackerBredHorses', JSON.stringify(bredHorses));
            localStorage.setItem('zedTrackerCpuAugments', JSON.stringify(cpuAugments));
            localStorage.setItem('zedTrackerRamAugments', JSON.stringify(ramAugments));
            localStorage.setItem('zedTrackerHydraulicAugments', JSON.stringify(hydraulicAugments));
            localStorage.setItem('zedTrackerRetirementEarnings', totalRetirementEarnings.toString());
            localStorage.setItem('horseTableItemsPerPage', horseTableItemsPerPage.toString()); // Save items per page
            localStorage.setItem('raceTableItemsPerPage', raceTableItemsPerPage.toString()); // Save races pref
            localStorage.setItem('breedingHorseTableItemsPerPage', breedingHorseTableItemsPerPage.toString()); // Save breeding pref
            localStorage.setItem('bredHistoryTableItemsPerPage', bredHistoryTableItemsPerPage.toString()); // Save bred history pref
             console.log("Data saved to localStorage.");
        }

        // --- Populate UI Elements ---
         function populateAugmentDropdowns() {
            // Clear existing options first (keeping the "None" option)
            clearDropdown(cpuAugmentSelect);
            clearDropdown(ramAugmentSelect);
            clearDropdown(hydraulicAugmentSelect);

            populateDropdown(cpuAugmentSelect, cpuAugments);
            populateDropdown(ramAugmentSelect, ramAugments);
            populateDropdown(hydraulicAugmentSelect, hydraulicAugments);

            // Populate the management lists with delete buttons
            populateManagementList(cpuAugmentList, cpuAugments, 'CPU');
            populateManagementList(ramAugmentList, ramAugments, 'RAM');
            populateManagementList(hydraulicAugmentList, hydraulicAugments, 'Hydraulic');
         }

         function clearDropdown(selectElement) {
            // Clear options except the first one ("None")
            while (selectElement.options.length > 1) {
                selectElement.remove(1);
            }
         }

         function populateDropdown(selectElement, options) {
            // Assumes first option ("None") is already present
            options.forEach(optionText => {
                const option = document.createElement('option');
                option.value = optionText;
                option.textContent = optionText;
                selectElement.appendChild(option);
            });
        }

         // Modified populateList to create management list with delete buttons
         function populateManagementList(ulElement, items, type) {
            ulElement.innerHTML = ''; // Clear existing items
            items.sort().forEach(itemText => { // Sort alphabetically
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${itemText}</span>
                    <button class="action-button delete-button" onclick="handleDeleteAugment('${itemText}', '${type}')" title="Delete Augment">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                `;
                ulElement.appendChild(li);
            });
         }

        function updateHorseDropdown() {
            raceHorseSelect.innerHTML = '<option value="">--Select Racing Horse--</option>';
            // Only use active racing horses for the race form dropdown
            const racingHorses = horses.filter(h => h.status === 'racing');
            // Sort the racing horses alphabetically by name
            racingHorses.sort((a, b) => a.name.localeCompare(b.name));
            
            racingHorses.forEach(horse => {
                const option = document.createElement('option');
                option.value = horse.id;
                option.textContent = horse.name;
                raceHorseSelect.appendChild(option);
            });
             // Try to restore previous selection
             if (horses.some(h => h.id === raceHorseSelect.value && h.status === 'racing')) {
                raceHorseSelect.value = raceHorseSelect.value;
             }
        }

        function updateParentDropdowns() {
            const allHorses = [...horses]; // Use the unified list
            const currentSire = sireSelect.value;
            const currentDam = damSelect.value;

            sireSelect.innerHTML = '<option value="">--Select Male Parent--</option>';
            damSelect.innerHTML = '<option value="">--Select Female Parent--</option>';

            allHorses.sort((a, b) => a.name.localeCompare(b.name)); // Sort alphabetically

            allHorses.forEach(horse => {
                const option = document.createElement('option');
                option.value = horse.id;
                option.textContent = horse.name;

                if (horse.gender === 'Male') {
                    sireSelect.appendChild(option);
                } else if (horse.gender === 'Female') {
                    damSelect.appendChild(option);
                }
            });

             // Restore previous selections if possible
             if (allHorses.some(h => h.id === currentSire && h.gender === 'Male')) sireSelect.value = currentSire;
             if (allHorses.some(h => h.id === currentDam && h.gender === 'Female')) damSelect.value = currentDam;

             // Trigger stat display update for potentially restored selections
             displayParentStats(sireSelect.value, 'sire');
             displayParentStats(damSelect.value, 'dam');
        }


        // --- Rendering ---
        function renderHorsesTable() {
            horsesTableBody.innerHTML = '';

            // 1. Get the correctly filtered list of horses WITH their stats
            const filteredHorsesWithStats = getFilteredRacingHorses();

            // 2. Sort the filtered list
            const { key, direction } = racingHorseSort;
            // Create a mutable copy for sorting
            let horsesToSort = [...filteredHorsesWithStats];
            horsesToSort.sort((a, b) => {
                let valA, valB;
                switch (key) {
                    case 'name':
                    case 'bloodline':
                    case 'gender':
                        valA = a[key] || '';
                        valB = b[key] || '';
                        return valA.localeCompare(valB);
                    case 'stars': // Sort by overall stars
                        valA = Number(a.stars) || 0;
                        valB = Number(b.stars) || 0;
                        return valA - valB;
                    case 'mmr':
                        valA = a.calculatedStats?.currentMmr || 0;
                        valB = b.calculatedStats?.currentMmr || 0;
                        return valA - valB;
                    case 'zed':
                        valA = a.calculatedStats?.currentZedBalance || 0;
                        valB = b.calculatedStats?.currentZedBalance || 0;
                        return valA - valB;
                    case 'wins': // Sort by WINS part of W-P-S
                        valA = a.calculatedStats?.wins || 0;
                        valB = b.calculatedStats?.wins || 0;
                        return valA - valB;
                    case 'netProfit': // Sort by Net Profit
                        valA = a.calculatedStats?.netProfit || 0;
                        valB = b.calculatedStats?.netProfit || 0;
                        return valA - valB;
                    case 'winRate':
                        valA = a.calculatedStats?.winRate || 0;
                        valB = b.calculatedStats?.winRate || 0;
                        return valA - valB;
                    case 'races':
                        valA = a.calculatedStats?.totalRaces || 0;
                        valB = b.calculatedStats?.totalRaces || 0;
                        return valA - valB;
                    default:
                        return 0;
                }
            });

            if (direction === 'desc') {
                horsesToSort.reverse();
            }

            // 3. Pagination Calculation
            const totalItems = horsesToSort.length;
            const totalPages = Math.ceil(totalItems / horseTableItemsPerPage);
            // Ensure currentPage is valid after filtering/itemsPerPage change
            if (horseTableCurrentPage > totalPages) {
                horseTableCurrentPage = Math.max(totalPages, 1); // Go to last page or 1 if empty
            }
            const startIndex = (horseTableCurrentPage - 1) * horseTableItemsPerPage;
            const endIndex = startIndex + horseTableItemsPerPage;
            const horsesToShow = horsesToSort.slice(startIndex, endIndex);

            // 4. Update header sort indicators
            updateSortIndicators();

            // 5. Render the *sliced* rows
            horsesToShow.forEach(horseData => {
                const horse = horseData; // Original horse data
                const stats = horseData.calculatedStats; // Pre-calculated stats

                const row = horsesTableBody.insertRow();
                const formatStars = (stars) => (stars !== null && stars !== undefined && stars !== '') ? Number(stars).toFixed(1) : '-';

                row.innerHTML = `
                    <td>${horse.name}</td>
                    <td>${horse.bloodline}</td>
                    <td>${horse.gender}</td>
                    <td>${formatStars(horse.stars)}</td>
                    <td>${stats.currentMmr}</td>
                    <td style="color: ${stats.currentZedBalance >= horse.initialZedBalance ? 'var(--success-color)' : 'var(--error-color)'};">${Math.round(stats.currentZedBalance)}</td>
                    <td>${stats.wins}-${stats.places}-${stats.shows}</td>
                    <td style="color: ${stats.netProfit >= 0 ? 'var(--success-color)' : 'var(--error-color)'};">
                        ${stats.netProfit >= 0 ? '+' : ''}${Math.round(stats.netProfit)}
                        ${stats.roi !== null ? ` (${stats.roi.toFixed(1)}%)` : ''}
                    </td>
                    <td>${stats.winRate.toFixed(1)}%</td>
                    <td>${stats.totalRaces}</td>
                    <td class="actions">
                        <button class="action-button edit-button" onclick="editHorse('${horse.id}')" title="Edit Horse">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="action-button retire-button" onclick="handleRetireHorse('${horse.id}')" title="Retire Horse">
                            <!-- Using a box-arrow-right icon for retire -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 22H5a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h5"></path><polyline points="17 16 21 12 17 8"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        </button>
                        <button class="action-button delete-button" onclick="deleteHorse('${horse.id}')" title="Delete Horse">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    </td>
                `;
            });

            // 6. Render Pagination Controls
            renderHorsePaginationControls(totalItems, totalPages);
        }

        // --- Pagination Control Rendering for Horses Table ---
        function renderHorsePaginationControls(totalItems, totalPages) {
            // Get references inside the function to ensure they exist if called early
            const itemsPerPageSelectContainer = horsesItemsPerPageSelect?.parentElement;
            const pageNavContainer = horsesPageInfoSpan?.parentElement;
            const controlsContainer = document.getElementById('horses-pagination-controls');

            if (!horsesPageInfoSpan || !horsesPrevPageButton || !horsesNextPageButton || !controlsContainer || !pageNavContainer || !itemsPerPageSelectContainer) {
                console.warn("Pagination elements not found, skipping control render.");
                return;
            }

            // Always show the main container, even if there are no items
            controlsContainer.style.display = 'flex';

            // Update page info text
            if (totalItems === 0) {
                horsesPageInfoSpan.textContent = 'No horses found';
            } else {
                horsesPageInfoSpan.textContent = `Page ${horseTableCurrentPage} of ${totalPages} (${totalItems} items)`;
            }

            // Enable/disable buttons
            horsesPrevPageButton.disabled = horseTableCurrentPage <= 1;
            horsesNextPageButton.disabled = horseTableCurrentPage >= totalPages;

            // Always show the navigation controls
            pageNavContainer.style.display = 'flex';
        }

        // --- Pagination Event Handlers ---
        function handleHorsesItemsPerPageChange() {
            const newSize = parseInt(horsesItemsPerPageSelect.value, 10);
            if (!isNaN(newSize) && newSize > 0) {
                horseTableItemsPerPage = newSize;
                horseTableCurrentPage = 1; // Reset to first page
                localStorage.setItem('horseTableItemsPerPage', horseTableItemsPerPage.toString()); // Save preference
                renderHorsesTable();
            }
        }

        function handleHorsesPrevPage() {
            // No need to recalculate totalPages for prev, just check current page > 1
            if (horseTableCurrentPage > 1) {
                horseTableCurrentPage--;
                renderHorsesTable();
            }
        }

        function handleHorsesNextPage() {
            // Use the helper function to get the length of the currently filtered list
            const filteredHorses = getFilteredRacingHorses();
            const totalItems = filteredHorses.length;
            const totalPages = Math.ceil(totalItems / horseTableItemsPerPage);

            if (horseTableCurrentPage < totalPages) {
                horseTableCurrentPage++;
                renderHorsesTable();
            }
        }

        function renderRacesTable() {
            racesTableBody.innerHTML = '';
             const sortedRaces = [...races].sort((a, b) => new Date(b.date) - new Date(a.date));

            // Pagination Calculation for Races
            const totalItems = sortedRaces.length;
            const totalPages = Math.ceil(totalItems / raceTableItemsPerPage);
            if (raceTableCurrentPage > totalPages) {
                raceTableCurrentPage = Math.max(totalPages, 1);
            }
            const startIndex = (raceTableCurrentPage - 1) * raceTableItemsPerPage;
            const endIndex = startIndex + raceTableItemsPerPage;
            const racesToShow = sortedRaces.slice(startIndex, endIndex);

            // Render the sliced rows
            racesToShow.forEach(race => {
                const horse = horses.find(h => h.id === race.horseId);
                const row = racesTableBody.insertRow();
                // Updated row structure to remove deleted columns
                row.innerHTML = `
                    <td>${new Date(race.date).toLocaleDateString()} ${new Date(race.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
                    <td>${horse ? horse.name : 'N/A'}</td>
                    <td>${race.position}</td>
                    <td>${race.odds}</td>
                    <td>${race.finishTime ? race.finishTime.toFixed(3) : '-'}</td>
                    <td style="color: ${race.zedChange >= 0 ? 'var(--success-color)' : 'var(--error-color)'};">${race.zedChange >= 0 ? '+' : ''}${Math.round(race.zedChange)}</td>
                    <td style="color: ${race.ratingChange > 0 ? 'var(--success-color)' : (race.ratingChange < 0 ? 'var(--error-color)' : 'inherit')};">${race.ratingChange > 0 ? '+' : ''}${race.ratingChange !== null ? race.ratingChange : '-'}</td>
                    <td>${race.cpuAugment !== 'None' ? 'C' : '-'}/${race.ramAugment !== 'None' ? 'R' : '-'}/${race.hydraulicAugment !== 'None' ? 'H' : '-'}</td>
                     <td class="actions">
                        <button class="action-button edit-button" onclick="editRace('${race.id}')" title="Edit Race">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="action-button delete-button" onclick="deleteRace('${race.id}')" title="Delete Race">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                     </td>
                `;
            });

            // Render Pagination Controls for Races
            renderRacePaginationControls(totalItems, totalPages);
        }

        // --- Pagination Control Rendering for Races Table ---
        function renderRacePaginationControls(totalItems, totalPages) {
            const pageNavContainer = racesPageInfoSpan?.parentElement;
            const controlsContainer = document.getElementById('races-pagination-controls');

            if (!racesPageInfoSpan || !racesPrevPageButton || !racesNextPageButton || !controlsContainer || !pageNavContainer) {
                console.warn("Race pagination elements not found, skipping control render.");
                return;
            }

            controlsContainer.style.display = 'flex';

            if (totalItems === 0) {
                racesPageInfoSpan.textContent = 'No races found';
            } else {
                racesPageInfoSpan.textContent = `Page ${raceTableCurrentPage} of ${totalPages} (${totalItems} items)`;
            }

            racesPrevPageButton.disabled = raceTableCurrentPage <= 1;
            racesNextPageButton.disabled = raceTableCurrentPage >= totalPages;
            pageNavContainer.style.display = 'flex';
        }

        // --- Pagination Event Handlers for Races ---
        function handleRacesItemsPerPageChange() {
            const newSize = parseInt(racesItemsPerPageSelect.value, 10);
            if (!isNaN(newSize) && newSize > 0) {
                raceTableItemsPerPage = newSize;
                raceTableCurrentPage = 1; // Reset to first page
                localStorage.setItem('raceTableItemsPerPage', raceTableItemsPerPage.toString()); // Save preference
                renderRacesTable();
            }
        }

        function handleRacesPrevPage() {
            if (raceTableCurrentPage > 1) {
                raceTableCurrentPage--;
                renderRacesTable();
            }
        }

        function handleRacesNextPage() {
            const totalItems = races.length; // Use full race list length
            const totalPages = Math.ceil(totalItems / raceTableItemsPerPage);
            if (raceTableCurrentPage < totalPages) {
                raceTableCurrentPage++;
                renderRacesTable();
            }
        }

        // --- Rendering for Retired Horses ---
        function renderBreedingHorsesTable() { // Renamed function
            breedingStableTableBody.innerHTML = ''; // Use distinct variable name
            const formatStars = (stars) => (stars !== null && stars !== undefined && stars !== '') ? Number(stars).toFixed(1) : '-';

            // Filter for breeding horses
            const breedingHorsesFiltered = horses.filter(h => h.status === 'breeding'); // Filter for 'breeding' status
            // TODO: Add sorting if needed later (e.g., by name)
            breedingHorsesFiltered.sort((a, b) => a.name.localeCompare(b.name)); // Sort by name ASC for now

            // Pagination Calculation for Breeding Horses
            const totalItems = breedingHorsesFiltered.length;
            const totalPages = Math.ceil(totalItems / breedingHorseTableItemsPerPage);
            if (breedingHorseTableCurrentPage > totalPages) {
                breedingHorseTableCurrentPage = Math.max(totalPages, 1);
            }
            const startIndex = (breedingHorseTableCurrentPage - 1) * breedingHorseTableItemsPerPage;
            const endIndex = startIndex + breedingHorseTableItemsPerPage;
            const horsesToShow = breedingHorsesFiltered.slice(startIndex, endIndex);

            // Render the sliced rows
            horsesToShow.forEach(horse => {
                const row = breedingStableTableBody.insertRow(); // Use distinct variable name
                const starsCombined = `O:${formatStars(horse.stars)} / Sp:${formatStars(horse.speedStars)} / Sr:${formatStars(horse.sprintStars)} / E:${formatStars(horse.enduranceStars)}`;

                row.innerHTML = `
                    <td>${horse.name}</td>
                    <td>${horse.bloodline}</td>
                    <td>${horse.gender}</td>
                    <td>${starsCombined}</td>
                    <td class="actions">
                        <button class="action-button edit-button" onclick="editHorse('${horse.id}')" title="Edit Breeding Horse">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="action-button" onclick="showHorseDetailsModal('${horse.id}')" title="View Details">
                           <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        </button>
                        <button class="action-button delete-button" onclick="deleteHorse('${horse.id}')" title="Delete Breeding Horse">
                           <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                     </td>
                `;
            });

            // Render Pagination Controls for Breeding Horses
            renderBreedingHorsePaginationControls(totalItems, totalPages);
        }

        // --- Pagination Control Rendering for Breeding Horses Table ---
        function renderBreedingHorsePaginationControls(totalItems, totalPages) {
            const itemsPerPageSelectContainer = breedingHorsesItemsPerPageSelect?.parentElement;
            const pageNavContainer = breedingHorsesPageInfoSpan?.parentElement; 
            const controlsContainer = document.getElementById('breeding-horses-pagination-controls');

            if (!breedingHorsesPageInfoSpan || !breedingHorsesPrevPageButton || !breedingHorsesNextPageButton || !controlsContainer || !pageNavContainer || !itemsPerPageSelectContainer) {
                console.warn("Breeding horse pagination elements not fully found, skipping control render.");
                return;
            }

            controlsContainer.style.display = 'flex';

            if (totalItems === 0) {
                breedingHorsesPageInfoSpan.textContent = 'No breeding horses found';
            } else {
                breedingHorsesPageInfoSpan.textContent = `Page ${breedingHorseTableCurrentPage} of ${totalPages} (${totalItems} items)`;
            }

            breedingHorsesPrevPageButton.disabled = breedingHorseTableCurrentPage <= 1;
            breedingHorsesNextPageButton.disabled = breedingHorseTableCurrentPage >= totalPages;
            
            pageNavContainer.style.display = 'flex';
        }

        // --- Pagination Event Handlers for Breeding Horses ---
        function handleBreedingHorsesItemsPerPageChange() {
            const newSize = parseInt(breedingHorsesItemsPerPageSelect.value, 10);
            if (!isNaN(newSize) && newSize > 0) {
                breedingHorseTableItemsPerPage = newSize;
                breedingHorseTableCurrentPage = 1; // Reset to first page
                localStorage.setItem('breedingHorseTableItemsPerPage', breedingHorseTableItemsPerPage.toString()); // Save preference
                renderBreedingHorsesTable();
            }
        }

        function handleBreedingHorsesPrevPage() {
            if (breedingHorseTableCurrentPage > 1) {
                breedingHorseTableCurrentPage--;
                renderBreedingHorsesTable();
            }
        }

        function handleBreedingHorsesNextPage() {
            // Recalculate totalPages based on current filters (just status='breeding')
            const totalItems = horses.filter(h => h.status === 'breeding').length;
            const totalPages = Math.ceil(totalItems / breedingHorseTableItemsPerPage);
            if (breedingHorseTableCurrentPage < totalPages) {
                breedingHorseTableCurrentPage++;
                renderBreedingHorsesTable();
            }
        }

         // --- Calculations ---
         function calculateHorseStats(horseId) {
             const horse = horses.find(h => h.id === horseId); // Find in unified list
              if (!horse) return { currentMmr: 'N/A', currentZedBalance: 0, wins: 0, places: 0, shows: 0, winRate: 0, totalRaces: 0 };

             const relevantRaces = races.filter(r => r.horseId === horseId);
              // Ensure initial values are treated as numbers - crucial for retired horses which might lack these initially
              let currentMmr = Number(horse.initialMmRating !== undefined ? horse.initialMmRating : 1000); // Default if missing
              let currentZedBalance = Number(horse.initialZedBalance !== undefined ? horse.initialZedBalance : 0); // Default if missing
             let wins = 0;
             let places = 0; // 2nd
             let shows = 0; // 3rd

             relevantRaces.forEach(race => {
                  // Ensure changes are numbers
                  currentMmr += Number(race.ratingChange);
                  currentZedBalance += Number(race.zedChange);
                  const position = Number(race.position);
                  if (position === 1) wins++;
                  else if (position === 2) places++;
                  else if (position === 3) shows++;
             });

             const totalRaces = relevantRaces.length;
             const winRate = totalRaces > 0 ? (wins / totalRaces) * 100 : 0;

             // Calculate Net Profit and ROI
             const initialBalance = Number(horse.initialZedBalance !== undefined ? horse.initialZedBalance : 0);
             const netProfit = currentZedBalance - initialBalance;
             const roi = (initialBalance > 0) ? (netProfit / initialBalance) * 100 : null; // Calculate ROI only if initial balance > 0

             return {
                 currentMmr,
                 currentZedBalance,
                 wins,
                 places,
                 shows,
                 winRate,
                 totalRaces,
                 netProfit, // Add netProfit
                 roi // Add roi
             };
         }

        function updateOverallStats() {
            let totalZedChange = 0;
            let totalStudFeesPaid = 0;
            
            // Calculate based on current balances vs initial balances for *active* racing horses
            horses.forEach(horse => {
                // Only consider racing horses for ZED change calculation
                if (horse.status === 'racing') { 
                    const stats = calculateHorseStats(horse.id);
                    // Check if stats calculation was successful before accessing properties
                    if (stats && stats.currentZedBalance !== undefined && horse.initialZedBalance !== undefined) {
                        totalZedChange += (stats.currentZedBalance - Number(horse.initialZedBalance));
                    }
                }
            });

            // Calculate total stud fees from bredHorses records
            bredHorses.forEach(bred => {
                 if (bred.studFeePaid && !isNaN(bred.studFeePaid)) {
                    totalStudFeesPaid += Number(bred.studFeePaid);
                }
            });

            // Update Total Races
            totalRacesSpan.textContent = ` ${races.length}`;
            totalRacesSpan.style.color = 'inherit'; // Default color
            
            // Update Total $ZED Change
            totalZedChangeSpan.textContent = ` ${totalZedChange >= 0 ? '+' : ''}${totalZedChange.toFixed(2)}`;
            totalZedChangeSpan.style.color = totalZedChange >= 0 ? 'var(--success-color)' : 'var(--error-color)';
            
            // Update Total Retirement Earnings
            totalRetirementEarningsSpan.textContent = ` ${totalRetirementEarnings.toFixed(2)}`;
            totalRetirementEarningsSpan.style.color = 'var(--success-color)';
            
            // Update Total Stud Fees Paid
            totalStudFeesSpan.textContent = ` ${totalStudFeesPaid.toFixed(2)}`;
            totalStudFeesSpan.style.color = 'var(--error-color)';
        }


        // --- Event Handlers ---
        function setupEventListeners() {
            addHorseForm.addEventListener('submit', handleAddHorse);
            addRaceForm.addEventListener('submit', handleAddRace);
            addBredHorseForm.addEventListener('submit', handleAddBredHorse);
            addBreedingHorseForm.addEventListener('submit', handleAddBreedingHorse); // Listener for new form
            // Listen for changes on parent dropdowns
            sireSelect.addEventListener('change', (e) => displayParentStats(e.target.value, 'sire'));
            damSelect.addEventListener('change', (e) => displayParentStats(e.target.value, 'dam'));

            // Tab switching listener
            tabButtonContainer.addEventListener('click', handleTabClick);

            // Augment management listener
            addAugmentForm.addEventListener('submit', handleAddAugment);
            
            // Sort listener for horses table
            document.querySelectorAll('#horses-table th[data-sort-key]').forEach(th => {
                th.addEventListener('click', handleSortClick);
            });

            // Listener for External Sire checkbox
            if (useExternalSireCheckbox) {
                useExternalSireCheckbox.addEventListener('change', toggleExternalSireFields);
            }

            // Listener for Export Button
            const exportButton = document.getElementById('export-data-button');
            if (exportButton) {
                exportButton.addEventListener('click', handleExportData);
            }

            // Add listener for analysis refresh button
            const refreshAnalysisButton = document.getElementById('augment-analysis-refresh');
            if (refreshAnalysisButton) {
                refreshAnalysisButton.addEventListener('click', function() {
                    // Explicitly check and set the min races value
                    const minRacesInput = document.getElementById('augment-analysis-min-races');
                    const bloodlineFilter = document.getElementById('augment-analysis-bloodline-filter');
                    
                    // Ensure the min races input has a valid value
                    if (minRacesInput && (!minRacesInput.value || isNaN(parseInt(minRacesInput.value)))) {
                        minRacesInput.value = "2"; // Default to 2 if invalid
                    }
                    
                    console.log("Refresh button clicked with settings - Min races:", 
                               minRacesInput ? minRacesInput.value : "unknown", 
                               "Bloodline:", bloodlineFilter ? bloodlineFilter.value : "unknown");
                    
                    // Force update all tables
                    renderBloodlineAnalysis();
                    renderIndividualAugmentAnalysis();
                    renderAugmentPairAnalysis();
                    renderTripleAugmentAnalysis();
                    
                    console.log("All analysis tables refreshed");
                });
            }
            
            // Add listeners for analysis filters
            const analysisBloodlineFilter = document.getElementById('augment-analysis-bloodline-filter');
            const analysisMinRaces = document.getElementById('augment-analysis-min-races');
            
            if (analysisBloodlineFilter) {
                analysisBloodlineFilter.addEventListener('change', function() {
                    console.log("Bloodline filter changed to:", analysisBloodlineFilter.value);
                    renderBloodlineAnalysis();
                    renderIndividualAugmentAnalysis();
                    renderAugmentPairAnalysis();
                    renderTripleAugmentAnalysis();
                });
            }
            
            if (analysisMinRaces) {
                // Remove any existing event listeners
                analysisMinRaces.removeEventListener('input', function() {});
                
                // Add change event which fires when input loses focus or enter is pressed
                analysisMinRaces.addEventListener('change', function() {
                    // Validate value
                    const minRaces = parseInt(this.value) || 2;
                    this.value = minRaces; // Update input with valid value
                    
                    console.log("Min races changed to:", minRaces);
                    renderBloodlineAnalysis();
                    renderIndividualAugmentAnalysis();
                    renderAugmentPairAnalysis();
                    renderTripleAugmentAnalysis();
                });
            }

            // Listeners for Imported Data
            const importButton = document.getElementById('import-data-button');
            const importFileInput = document.getElementById('import-file-input');
            if (importButton && importFileInput) {
                importButton.addEventListener('click', () => {
                    importFileInput.click(); // Trigger hidden file input
                });
                importFileInput.addEventListener('change', handleImportData);
            }

            // Listeners for Table Filter/Search
            if (horseFilterBloodline) {
                horseFilterBloodline.addEventListener('change', renderHorsesTable);
            }
            
            if (horseFilterGender) {
                horseFilterGender.addEventListener('change', renderHorsesTable);
            }
            
            // Star filters
            [horseFilterMinStars, horseFilterMaxStars, horseFilterMinSpeed, horseFilterMaxSpeed, 
             horseFilterMinSprint, horseFilterMaxSprint, horseFilterMinEndurance, 
             horseFilterMaxEndurance].forEach(input => {
                if (input) {
                    input.addEventListener('input', renderHorsesTable);
                }
            });
            
            // Listener for Augment Analysis Horse Filter
            if (augmentAnalysisHorseFilter) {
                augmentAnalysisHorseFilter.addEventListener('change', renderAugmentAnalysis);
            }

            // Listeners for Horses Table Pagination Controls
            if (horsesItemsPerPageSelect) {
                horsesItemsPerPageSelect.value = horseTableItemsPerPage;
                horsesItemsPerPageSelect.addEventListener('change', handleHorsesItemsPerPageChange);
            }
            if (horsesPrevPageButton) {
                horsesPrevPageButton.addEventListener('click', handleHorsesPrevPage);
            }
            if (horsesNextPageButton) {
                horsesNextPageButton.addEventListener('click', handleHorsesNextPage);
            }

            // Listeners for Breeding Horse Pagination Controls
            if (breedingHorsesItemsPerPageSelect) {
                breedingHorsesItemsPerPageSelect.value = breedingHorseTableItemsPerPage;
                breedingHorsesItemsPerPageSelect.addEventListener('change', handleBreedingHorsesItemsPerPageChange);
            }
            if (breedingHorsesPrevPageButton) {
                breedingHorsesPrevPageButton.addEventListener('click', handleBreedingHorsesPrevPage);
            }
            if (breedingHorsesNextPageButton) {
                breedingHorsesNextPageButton.addEventListener('click', handleBreedingHorsesNextPage);
            }
            
            // Listeners for Race Pagination Controls
            if (racesItemsPerPageSelect) {
                racesItemsPerPageSelect.value = raceTableItemsPerPage;
                racesItemsPerPageSelect.addEventListener('change', handleRacesItemsPerPageChange);
            }
            if (racesPrevPageButton) {
                racesPrevPageButton.addEventListener('click', handleRacesPrevPage);
            }
            if (racesNextPageButton) {
                racesNextPageButton.addEventListener('click', handleRacesNextPage);
            }
            
            // Bred Horse pagination controls
            if (bredHistoryItemsPerPageSelect) {
                bredHistoryItemsPerPageSelect.value = bredHistoryTableItemsPerPage;
                bredHistoryItemsPerPageSelect.addEventListener('change', handleBredHistoryItemsPerPageChange);
            }
            if (bredHistoryPrevPageButton) {
                bredHistoryPrevPageButton.addEventListener('click', handleBredHistoryPrevPage);
            }
            if (bredHistoryNextPageButton) {
                bredHistoryNextPageButton.addEventListener('click', handleBredHistoryNextPage);
            }
        }

        function toggleExternalSireFields() {
            const isChecked = useExternalSireCheckbox.checked;
            externalSireFields.forEach(field => {
                field.style.display = isChecked ? 'block' : 'none';
            });
            // Disable internal sire dropdown if external is checked, enable otherwise
            sireSelect.disabled = isChecked;
            if (isChecked) {
                sireSelect.value = ''; // Clear internal selection if switching to external
                displayParentStats(null, 'sire'); // Clear stats display
                externalSireNameInput.required = true; // Make external name required
                externalSireBloodlineSelect.required = true; // Make external bloodline required
            } else {
                externalSireNameInput.required = false;
                externalSireBloodlineSelect.required = false;
                sireSelect.required = true; // Ensure internal sire is required again
            }
        }

        function handleAddHorse(event) {
            event.preventDefault();
            console.log('[handleAddHorse] Started. currentlyEditingHorse:', currentlyEditingHorse); // Log at start of handleAddHorse
            // Get elements correctly
            const horseNameInput = document.getElementById('horse-name');
            const bloodlineSelect = document.getElementById('horse-bloodline');
            const genderSelect = document.getElementById('horse-gender');
            const starsInput = document.getElementById('horse-stars');
            const zedBalanceInput = document.getElementById('horse-zed-balance');
            const mmRatingInput = document.getElementById('horse-mm-rating');
            const speedStarsInput = document.getElementById('horse-speed-stars');
            const sprintStarsInput = document.getElementById('horse-sprint-stars');
            const enduranceStarsInput = document.getElementById('horse-endurance-stars');

            const parseFloatOptional = (value) => value ? parseFloat(value) : null;

            // Prepare data object - initially assume adding
            const horseData = {
                id: currentlyEditingHorse ? currentlyEditingHorse.id : null, // Use existing ID if editing
                name: horseNameInput.value.trim(),
                bloodline: bloodlineSelect.value,
                gender: genderSelect.value,
                stars: parseFloat(starsInput.value) || 0,
                initialZedBalance: parseFloat(zedBalanceInput.value) || 0,
                initialMmRating: parseInt(mmRatingInput.value) || 1000,
                speedStars: parseFloatOptional(speedStarsInput.value),
                sprintStars: parseFloatOptional(sprintStarsInput.value),
                enduranceStars: parseFloatOptional(enduranceStarsInput.value),
                status: 'racing' // This form always deals with racing horses
             };

            // --- Validation ---
            if (!horseData.name) { alert("Horse Name is required."); return; }
            if (!horseData.bloodline) { alert("Please select a Bloodline."); return; }
            if (!horseData.gender) { alert("Please select a Gender."); return; }
            if (isNaN(horseData.stars) || horseData.stars <= 0) { alert("Please enter a valid positive number for Overall Stars."); return; }
            if (isNaN(horseData.initialZedBalance)) { alert("Please enter a valid number for Initial $ZED Balance."); return; }
            if (isNaN(horseData.initialMmRating)) { alert("Please enter a valid number for Initial Matchmaking Rating."); return; }
            // Optional star validation
            if ((speedStarsInput.value && isNaN(horseData.speedStars)) ||
                (sprintStarsInput.value && isNaN(horseData.sprintStars)) ||
                (enduranceStarsInput.value && isNaN(horseData.enduranceStars))) {
                alert("Please enter valid numbers for Speed/Sprint/Endurance Stars, or leave them empty.");
                 return;
            }

            // --- Check if Updating or Adding --- //
            if (currentlyEditingHorse && currentlyEditingHorse.status === 'racing') {
                // --- UPDATE --- //
                const index = horses.findIndex(h => h.id === currentlyEditingHorse.id);
                if (index !== -1) {
                    // Merge updates, keeping original ID and ensuring status remains 'racing'
                    horses[index] = { ...horses[index], ...horseData, status: 'racing' };
                    console.log("Racing horse updated:", horses[index]);
                } else {
                    console.error("Could not find racing horse to update:", currentlyEditingHorse.id);
                    // Reset state even if update failed
                    currentlyEditingHorse = null;
                    addHorseForm.querySelector('button[type="submit"]').textContent = 'Add Racing Horse';
                    addHorseForm.reset();
                    return; // Stop execution
                }
            } else {
                 // --- ADD --- //
                // Check for duplicate names only when adding
                if (horses.some(h => h.name.toLowerCase() === horseData.name.toLowerCase())) {
                     alert(`A horse named "${horseData.name}" already exists.`);
                 return;
                }
                horseData.id = `horse-${Date.now()}-${Math.random().toString(16).slice(2)}`; // Generate new ID
                horses.push(horseData);
                 console.log("Racing horse added:", horseData);
             }

             // --- Post Add/Update Actions --- //
            saveData();
            renderHorsesTable();
            updateHorseDropdown();
             updateParentDropdowns();
             populateAugmentAnalysisHorseFilter(); // Refresh the horse filter dropdown
             addHorseForm.reset();
             addHorseForm.querySelector('button[type="submit"]').textContent = 'Add Racing Horse';
             currentlyEditingHorse = null;
        }

        // --- Add Breeding Horse Handler (Needs similar refactor) --- //
        function handleAddBreedingHorse(event) {
            event.preventDefault();
            console.log('[handleAddBreedingHorse] Started. currentlyEditingHorse:', currentlyEditingHorse); // Log at start of handleAddBreedingHorse
            const nameInput = document.getElementById('breeding-horse-name');
            const bloodlineSelect = document.getElementById('breeding-horse-bloodline');
            const genderSelect = document.getElementById('breeding-horse-gender');
            const starsInput = document.getElementById('breeding-horse-stars');
            const speedStarsInput = document.getElementById('breeding-horse-speed-stars');
            const sprintStarsInput = document.getElementById('breeding-horse-sprint-stars');
            const enduranceStarsInput = document.getElementById('breeding-horse-endurance-stars');

            const parseFloatOptional = (value) => value ? parseFloat(value) : null;

            const breedingHorseData = {
                id: currentlyEditingHorse ? currentlyEditingHorse.id : null,
                name: nameInput.value.trim(),
                bloodline: bloodlineSelect.value,
                gender: genderSelect.value,
                stars: parseFloatOptional(starsInput.value),
                speedStars: parseFloatOptional(speedStarsInput.value),
                sprintStars: parseFloatOptional(sprintStarsInput.value),
                enduranceStars: parseFloatOptional(enduranceStarsInput.value),
                status: 'breeding' // This form always deals with breeding horses
            };

            // --- Validation --- //
            if (!breedingHorseData.name) { alert("Horse Name is required."); return; }
            if (!breedingHorseData.bloodline) { alert("Please select a Bloodline."); return; }
            if (!breedingHorseData.gender) { alert("Please select a Gender."); return; }
            if ((starsInput.value && isNaN(breedingHorseData.stars)) ||
                (speedStarsInput.value && isNaN(breedingHorseData.speedStars)) ||
                (sprintStarsInput.value && isNaN(breedingHorseData.sprintStars)) ||
                (enduranceStarsInput.value && isNaN(breedingHorseData.enduranceStars))) {
                alert("Please enter valid numbers for Stars, or leave them empty.");
                return;
            }

            // --- Check if Updating or Adding --- //
            if (currentlyEditingHorse && currentlyEditingHorse.status === 'breeding') {
                 // --- UPDATE --- //
                const index = horses.findIndex(h => h.id === currentlyEditingHorse.id);
                if (index !== -1) {
                     // Merge updates, keeping original ID and ensuring status remains 'breeding'
                    horses[index] = { ...horses[index], ...breedingHorseData, status: 'breeding' };
                    console.log("Breeding horse updated:", horses[index]);
                } else {
                    console.error("Could not find breeding horse to update:", currentlyEditingHorse.id);
                    // Reset state even if update failed
                    currentlyEditingHorse = null;
                    addBreedingHorseForm.querySelector('button[type="submit"]').textContent = 'Add Breeding Horse';
                    addBreedingHorseForm.reset();
                    return; // Stop execution
                }
            } else {
                 // --- ADD --- //
                 // Check for duplicate names only when adding
                 if (horses.some(h => h.name.toLowerCase() === breedingHorseData.name.toLowerCase())) {
                    alert(`A horse named "${breedingHorseData.name}" already exists.`);
                    return;
                 }
                 breedingHorseData.id = `horse-${Date.now()}-${Math.random().toString(16).slice(2)}`;
                 horses.push(breedingHorseData);
                 console.log("Breeding horse added:", breedingHorseData);
            }

            // --- Post Add/Update Actions --- //
            saveData();
            renderBreedingHorsesTable();
            updateParentDropdowns();
            addBreedingHorseForm.reset();
            addBreedingHorseForm.querySelector('button[type="submit"]').textContent = 'Add Breeding Horse';
            currentlyEditingHorse = null;
        }

        function handleAddRace(event) {
            event.preventDefault();
            // Get elements
            const horseSelect = document.getElementById('race-horse');
            const positionInput = document.getElementById('race-position');
            const oddsInput = document.getElementById('race-odds');
            const timeInput = document.getElementById('race-finish-time');
            const zedChangeInput = document.getElementById('race-zed-change');
            const ratingChangeInput = document.getElementById('race-rating-change');
            const cpuSelect = document.getElementById('race-cpu-augment');
            const ramSelect = document.getElementById('race-ram-augment');
            const hydraulicSelect = document.getElementById('race-hydraulic-augment');

             const raceData = {
                horseId: horseSelect.value,
                position: parseInt(positionInput.value),
                odds: parseFloat(oddsInput.value),
                finishTime: parseFloat(timeInput.value) || null,
                zedChange: parseFloat(zedChangeInput.value),
                ratingChange: ratingChangeInput.value ? parseInt(ratingChangeInput.value) : null,
                cpuAugment: cpuSelect.value,
                ramAugment: ramSelect.value,
                hydraulicAugment: hydraulicSelect.value,
                 date: new Date().toISOString()
             };

            // Validation
            if (!raceData.horseId) { alert("Please select a horse."); return; }
            if (isNaN(raceData.position) || raceData.position < 1) { alert("Please enter a valid finishing place (1 or higher)."); return; }
            if (isNaN(raceData.odds) || raceData.odds < 1) { alert("Please enter valid odds (1 or higher)."); return; }
            // time is optional
            if (isNaN(raceData.zedChange)) { alert("Please enter the $ZED Won/Lost."); return; }
            // MM Change is now optional
            // Ensure MM Change is a number if provided
            if (ratingChangeInput.value && isNaN(raceData.ratingChange)) {
                alert("Please enter a valid number for the Matchmaking Rating Change, or leave it empty.");
                 return;
            }

            if (!horses.some(h => h.id === raceData.horseId)) {
                alert("Selected horse not found. Please add the horse first or refresh.");
                return;
            }

            if (currentlyEditingRace) {
                // Update existing race
                const index = races.findIndex(r => r.id === currentlyEditingRace.id);
                if (index !== -1) {
                    // Preserve the id and date from the original race
                    raceData.id = currentlyEditingRace.id;
                    raceData.date = currentlyEditingRace.date;
                    races[index] = raceData;
                    console.log("Race updated:", raceData);
                }
            } else {
                // Add new race
                raceData.id = `race-${Date.now()}-${Math.random().toString(16).slice(2)}`;
                raceData.date = new Date().toISOString();
            races.push(raceData);
                console.log("Race added:", raceData);
            }

            saveData();
            renderRacesTable();
            renderHorsesTable(); // Re-render horses to update calculated stats
            updateOverallStats();
            renderAugmentAnalysis();
            
            // Reset form and editing state
            addRaceForm.reset();
            horseSelect.value = ""; // Reset dropdown selection
            const submitButton = addRaceForm.querySelector('button[type="submit"]');
            submitButton.textContent = 'Record Race';
            currentlyEditingRace = null;
        }

        function handleAddBredHorse(event) {
            event.preventDefault();
            const nameInput = document.getElementById('bred-name');
            const bloodlineSelect = document.getElementById('bred-bloodline');
            const genderSelect = document.getElementById('bred-gender');
            const sireSelect = document.getElementById('bred-sire');
            const damSelect = document.getElementById('bred-dam');
            const dateInput = document.getElementById('bred-date');
            const starsInput = document.getElementById('bred-overall-stars');
            const speedStarsInput = document.getElementById('bred-speed-stars');
            const sprintStarsInput = document.getElementById('bred-sprint-stars');
            const enduranceStarsInput = document.getElementById('bred-endurance-stars');

            const parseFloatOptional = (value) => value ? parseFloat(value) : null;

            // Determine Sire details based on checkbox
            let sireId = null;
            let externalSireName = null;
            let externalSireBloodline = null;
            let externalSireOverallStars = null;
            let externalSireSpeedStars = null;
            let externalSireSprintStars = null;
            let externalSireEnduranceStars = null;

            if (useExternalSireCheckbox.checked) {
                externalSireName = externalSireNameInput.value.trim();
                externalSireBloodline = externalSireBloodlineSelect.value;
                // Retrieve external sire stars if checkbox is checked
                externalSireOverallStars = parseFloatOptional(document.getElementById('external-sire-overall-stars').value);
                externalSireSpeedStars = parseFloatOptional(document.getElementById('external-sire-speed-stars').value);
                externalSireSprintStars = parseFloatOptional(document.getElementById('external-sire-sprint-stars').value);
                externalSireEnduranceStars = parseFloatOptional(document.getElementById('external-sire-endurance-stars').value);
            } else {
                sireId = sireSelect.value;
            }

            const newBredHorse = {
                 id: `bred-${Date.now()}-${Math.random().toString(16).slice(2)}`,
                 name: nameInput.value.trim(),
                 bloodline: bloodlineSelect.value,
                 gender: genderSelect.value,
                 sireId: sireId, // Can be null if external
                 externalSireName: externalSireName, // Name if external
                 externalSireBloodline: externalSireBloodline, // Bloodline if external
                 externalSireOverallStars: externalSireOverallStars, // Store external sire stars
                 externalSireSpeedStars: externalSireSpeedStars,
                 externalSireSprintStars: externalSireSprintStars,
                 externalSireEnduranceStars: externalSireEnduranceStars,
                 damId: damSelect.value,
                 bredDate: dateInput.value || null,
                 studFeePaid: parseFloat(document.getElementById('bred-stud-fee').value) || 0,
                 stars: parseFloatOptional(starsInput.value),
                 speedStars: parseFloatOptional(speedStarsInput.value),
                 sprintStars: parseFloatOptional(sprintStarsInput.value),
                 enduranceStars: parseFloatOptional(enduranceStarsInput.value)
             };

            // Validation
             if (!newBredHorse.name) { alert("New Horse Name is required."); return; }
             if (!newBredHorse.bloodline) { alert("Please select a Bloodline for the new horse."); return; }
             if (!newBredHorse.gender) { alert("Please select a Gender for the new horse."); return; }
             if (!newBredHorse.sireId) { alert("Please select the Sire (Father)."); return; }
             if (!newBredHorse.damId) { alert("Please select the Dam (Mother)."); return; }
             if (isNaN(newBredHorse.studFeePaid)) { alert("Please enter a valid number for Stud Fee Paid (or 0)."); return; }

             // Check for duplicate names across ALL horses
             const allHorseNames = [...horses].map(h => h.name.toLowerCase());
             if (allHorseNames.includes(newBredHorse.name.toLowerCase())) {
                 alert(`A horse named "${newBredHorse.name}" already exists in the racing or breeding stable. Please choose a unique name for the bred horse.`);
                return;
            }

            bredHorses.push(newBredHorse);
             // Optional: Automatically add the bred horse to racing/breeding stable?
             // For now, we just record the breeding event.

             saveData();
             renderBredHorsesTable();
             addBredHorseForm.reset();
             sireStatsDiv.innerHTML = ''; // Clear parent stats display
             damStatsDiv.innerHTML = '';
             console.log("Bred horse recorded:", newBredHorse);
        }

         function deleteHorse(horseId) {
            // Find the horse to get its status and name for confirmation
            const horseIndex = horses.findIndex(horse => horse.id === horseId);
            if (horseIndex === -1) {
                console.error("Horse not found for deletion:", horseId);
                return;
            }
            const horseToDelete = horses[horseIndex];
            const originalStatus = horseToDelete.status; // Store status before potential modification

            if (confirm(`Are you sure you want to delete ${horseToDelete.name}? This action cannot be undone.`)) {
                // Filter the IN-MEMORY horses array
                horses = horses.filter(horse => horse.id !== horseId);
                saveData(); // Save the updated in-memory array

                // Re-render the correct table based on the original status
                if (originalStatus === 'racing') {
             renderHorsesTable();
                } else if (originalStatus === 'breeding') {
                    renderBreedingHorsesTable();
                }
                // Update dropdowns that might contain the deleted horse
             updateHorseDropdown();
                updateParentDropdowns();
                populateAugmentAnalysisHorseFilter(); // Refresh the horse filter dropdown
                updateOverallStats(); // Stats might be affected if it was a racing horse
                renderAugmentAnalysis(); // Re-render analysis
                console.log(`Horse ${horseToDelete.name} (ID: ${horseId}) deleted.`);
            }
         }

         function deleteRace(raceId) {
            const raceIndex = races.findIndex(r => r.id === raceId);
            if (raceIndex === -1) return; // Should not happen

             if (!confirm(`Are you sure you want to delete this race record from ${new Date(races[raceIndex].date).toLocaleString()}?`)) {
                 return;
             }

             races.splice(raceIndex, 1); // Use splice for efficiency if array gets large

             saveData();
             renderRacesTable();
             renderHorsesTable(); // Stats might change
             renderAugmentAnalysis();
             updateOverallStats();
              console.log("Race deleted:", raceId);
         }

        function deleteBredHorse(recordId) {
             const recordIndex = bredHorses.findIndex(r => r.id === recordId);
             if (recordIndex === -1) return;

             if (!confirm(`Are you sure you want to delete this bred horse record for "${bredHorses[recordIndex].name}"? This only removes the breeding record.`)) {
                  return;
              }

             bredHorses.splice(recordIndex, 1);

             saveData();
             renderBredHorsesTable();
             console.log("Bred horse record deleted:", recordId);
        }

        // --- Parent Stat Display ---
        function displayParentStats(horseId, parentType) {
            const displayDiv = parentType === 'sire' ? sireStatsDiv : damStatsDiv;
            if (!horseId) {
                displayDiv.innerHTML = ''; // Clear if no horse selected
                return;
            }

            const allHorses = [...horses]; // Use unified list
            const parent = allHorses.find(h => h.id === horseId);

            if (parent) {
                const format = (val) => (val !== null && val !== undefined && val !== '') ? Number(val).toFixed(1) : '-';
                displayDiv.innerHTML = `
                    <strong>${parent.bloodline}</strong> | 
                    Overall: ${format(parent.stars)} | 
                    Spd: ${format(parent.speedStars)} | 
                    Spr: ${format(parent.sprintStars)} | 
                    End: ${format(parent.enduranceStars)}
                `;
            } else {
                displayDiv.innerHTML = ''; // Clear if horse not found (shouldn't happen)
            }
        }

        // --- Augment Performance Analysis Rendering ---
        function renderAugmentAnalysis() {
           const container = document.getElementById('augment-analysis-content');
           container.innerHTML = ''; // Clear previous analysis

           if (horses.length === 0) {
               container.innerHTML = '<p>No racing horses available for analysis.</p>';
               return;
           }
           
           // Get the selected horse ID from the filter
           const selectedHorseId = augmentAnalysisHorseFilter ? augmentAnalysisHorseFilter.value : '';
           
           // Filter horses based on selection (or show all if none selected)
           const horsesToAnalyze = selectedHorseId 
               ? horses.filter(h => h.id === selectedHorseId && h.status === 'racing')
               : horses.filter(h => h.status === 'racing');

           horsesToAnalyze.forEach(horse => {
               const horseRaces = races.filter(r => r.horseId === horse.id);

               if (horseRaces.length === 0) {
                   // Optionally skip horses with no races, or show a message
                   // container.innerHTML += `<h3>${horse.name}</h3><p>No races recorded yet.</p>`;
                   return; // Skip for now if no races
               }

               // Group races by augment combination
               const analysis = {};
               horseRaces.forEach(race => {
                   const comboKey = `${race.cpuAugment || 'None'} / ${race.ramAugment || 'None'} / ${race.hydraulicAugment || 'None'}`;
                   if (!analysis[comboKey]) {
                       analysis[comboKey] = {
                           races: 0,
                           wins: 0,
                           placeSum: 0,
                           oddsSum: 0
                       };
                   }
                   analysis[comboKey].races++;
                   if (race.position === 1) analysis[comboKey].wins++;
                   analysis[comboKey].placeSum += race.position;
                    // Odds might be null/undefined if not entered, handle carefully
                    if (race.odds !== null && race.odds !== undefined && !isNaN(race.odds)) {
                         analysis[comboKey].oddsSum += Number(race.odds);
                    } else {
                         // Decide how to handle races with missing odds for Avg calculation
                         // Option 1: Exclude them from Avg Odds (might skew results if many are missing)
                         // Option 2: Treat as 0 (will lower avg)
                         // Option 3: Keep a separate count of races with odds
                         // Let's use Option 1 for now - add a counter
                         analysis[comboKey].racesWithOdds = (analysis[comboKey].racesWithOdds || 0) + 1;
                    }

               });

               // Build HTML for this horse
                const horseDiv = document.createElement('div');
                horseDiv.className = 'horse-analysis'; // Add class for potential future styling
                horseDiv.innerHTML = `<h3>${horse.name}</h3>`;

                const table = document.createElement('table');
                table.innerHTML = `
                   <thead>
                       <tr>
                           <th>Augment Combo (C/R/H)</th>
                           <th>Races</th>
                           <th>Win %</th>
                           <th>Avg Place</th>
                           <th>Avg Odds</th>
                       </tr>
                   </thead>
                   <tbody>
                   </tbody>
               `;
               const tbody = table.querySelector('tbody');

               Object.entries(analysis).sort(([keyA], [keyB]) => keyA.localeCompare(keyB)).forEach(([comboKey, stats]) => {
                    const winRate = stats.races > 0 ? (stats.wins / stats.races) * 100 : 0;
                    const avgPlace = stats.races > 0 ? stats.placeSum / stats.races : 0;
                    const racesWithOddsCount = stats.races - (stats.racesWithOdds || 0);
                    const avgOdds = racesWithOddsCount > 0 ? stats.oddsSum / racesWithOddsCount : 0;

                   const row = tbody.insertRow();
                   row.innerHTML = `
                       <td>${comboKey}</td>
                       <td>${stats.races}</td>
                       <td>${winRate.toFixed(1)}%</td>
                       <td>${avgPlace.toFixed(2)}</td>
                       <td>${avgOdds > 0 ? avgOdds.toFixed(1) : 'N/A'}</td>
                   `;
               });

                horseDiv.appendChild(table);
                container.appendChild(horseDiv);

           });
           
           // Add Advanced Augment Analysis by Bloodline
           renderAdvancedAugmentAnalysis(container);
        }
        
        // New function for enhanced augment analytics
        function renderAdvancedAugmentAnalysis(container) {
            // Create a section for advanced analytics
            const advancedSection = document.createElement('div');
            advancedSection.className = 'advanced-augment-analysis';
            advancedSection.innerHTML = '<h2>Advanced Augment Analytics</h2>';
            
            // Get all racing horses with races
            const racingHorses = horses.filter(h => h.status === 'racing');
            if (racingHorses.length === 0) {
                advancedSection.innerHTML += '<p>No racing horses available for analysis.</p>';
                container.appendChild(advancedSection);
                return;
            }
            
            // Collect all races for racing horses
            const allRaces = [];
            racingHorses.forEach(horse => {
                const horseRaces = races.filter(r => r.horseId === horse.id);
                // Add horse bloodline to each race for analysis
                horseRaces.forEach(race => {
                    allRaces.push({
                        ...race,
                        bloodline: horse.bloodline
                    });
                });
            });
            
            if (allRaces.length === 0) {
                advancedSection.innerHTML += '<p>No race data available for analysis.</p>';
                container.appendChild(advancedSection);
                return;
            }
            
            // Create bloodline performance section
            const bloodlineSection = document.createElement('div');
            bloodlineSection.innerHTML = '<h3>Augment Performance by Bloodline</h3>';
            
            // Group races by bloodline
            const bloodlineGroups = {};
            const bloodlines = ['Nakamoto', 'Szabo', 'Finney', 'Buterin'];
            
            bloodlines.forEach(bloodline => {
                bloodlineGroups[bloodline] = allRaces.filter(race => race.bloodline === bloodline);
            });
            
            // Create a table for bloodline performance
            const bloodlineTable = document.createElement('table');
            bloodlineTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Bloodline</th>
                        <th>Races</th>
                        <th>Win %</th>
                        <th>Avg Place</th>
                        <th>Avg Odds</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            
            const bloodlineTbody = bloodlineTable.querySelector('tbody');
            
            bloodlines.forEach(bloodline => {
                const bloodlineRaces = bloodlineGroups[bloodline];
                if (bloodlineRaces.length === 0) return;
                
                const wins = bloodlineRaces.filter(r => r.position === 1).length;
                const winRate = (wins / bloodlineRaces.length) * 100;
                const placeSum = bloodlineRaces.reduce((sum, race) => sum + race.position, 0);
                const avgPlace = placeSum / bloodlineRaces.length;
                
                // Calculate average odds (excluding races with missing odds)
                const racesWithOdds = bloodlineRaces.filter(r => r.odds !== null && r.odds !== undefined && !isNaN(r.odds));
                const oddsSum = racesWithOdds.reduce((sum, race) => sum + Number(race.odds), 0);
                const avgOdds = racesWithOdds.length > 0 ? oddsSum / racesWithOdds.length : 0;
                
                const row = bloodlineTbody.insertRow();
                row.innerHTML = `
                    <td>${bloodline}</td>
                    <td>${bloodlineRaces.length}</td>
                    <td>${winRate.toFixed(1)}%</td>
                    <td>${avgPlace.toFixed(2)}</td>
                    <td>${avgOdds > 0 ? avgOdds.toFixed(1) : 'N/A'}</td>
                `;
            });
            
            bloodlineSection.appendChild(bloodlineTable);
            advancedSection.appendChild(bloodlineSection);
            
            // Create individual augment analysis section
            const individualAugmentSection = document.createElement('div');
            individualAugmentSection.innerHTML = '<h3>Individual Augment Performance</h3>';
            
            // Collect data on individual augments
            const augmentStats = {};
            
            allRaces.forEach(race => {
                // Process CPU augment
                if (race.cpuAugment) {
                    if (!augmentStats[race.cpuAugment]) {
                        augmentStats[race.cpuAugment] = { type: 'CPU', races: 0, wins: 0, placeSum: 0, oddsValues: [] };
                    }
                    augmentStats[race.cpuAugment].races++;
                    if (race.position === 1) augmentStats[race.cpuAugment].wins++;
                    augmentStats[race.cpuAugment].placeSum += race.position;
                    if (race.odds !== null && race.odds !== undefined && !isNaN(race.odds)) {
                        augmentStats[race.cpuAugment].oddsValues.push(Number(race.odds));
                    }
                }
                
                // Process RAM augment
                if (race.ramAugment) {
                    if (!augmentStats[race.ramAugment]) {
                        augmentStats[race.ramAugment] = { type: 'RAM', races: 0, wins: 0, placeSum: 0, oddsValues: [] };
                    }
                    augmentStats[race.ramAugment].races++;
                    if (race.position === 1) augmentStats[race.ramAugment].wins++;
                    augmentStats[race.ramAugment].placeSum += race.position;
                    if (race.odds !== null && race.odds !== undefined && !isNaN(race.odds)) {
                        augmentStats[race.ramAugment].oddsValues.push(Number(race.odds));
                    }
                }
                
                // Process Hydraulic augment
                if (race.hydraulicAugment) {
                    if (!augmentStats[race.hydraulicAugment]) {
                        augmentStats[race.hydraulicAugment] = { type: 'Hydraulic', races: 0, wins: 0, placeSum: 0, oddsValues: [] };
                    }
                    augmentStats[race.hydraulicAugment].races++;
                    if (race.position === 1) augmentStats[race.hydraulicAugment].wins++;
                    augmentStats[race.hydraulicAugment].placeSum += race.position;
                    if (race.odds !== null && race.odds !== undefined && !isNaN(race.odds)) {
                        augmentStats[race.hydraulicAugment].oddsValues.push(Number(race.odds));
                    }
                }
            });
            
            // Create a table for individual augment performance
            const augmentTable = document.createElement('table');
            augmentTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Augment</th>
                        <th>Type</th>
                        <th>Races</th>
                        <th>Win %</th>
                        <th>Avg Place</th>
                        <th>Avg Odds</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            
            const augmentTbody = augmentTable.querySelector('tbody');
            
            // Sort augments by win rate (descending)
            Object.entries(augmentStats)
                .sort(([, statsA], [, statsB]) => {
                    const winRateA = statsA.races > 0 ? (statsA.wins / statsA.races) * 100 : 0;
                    const winRateB = statsB.races > 0 ? (statsB.wins / statsB.races) * 100 : 0;
                    return winRateB - winRateA;
                })
                .forEach(([augmentName, stats]) => {
                    if (stats.races < 3) return; // Skip augments with too few races
                    
                    const winRate = stats.races > 0 ? (stats.wins / stats.races) * 100 : 0;
                    const avgPlace = stats.races > 0 ? stats.placeSum / stats.races : 0;
                    const avgOdds = stats.oddsValues.length > 0 
                        ? stats.oddsValues.reduce((sum, odds) => sum + odds, 0) / stats.oddsValues.length 
                        : 0;
                    
                    const row = augmentTbody.insertRow();
                    row.innerHTML = `
                        <td>${augmentName}</td>
                        <td>${stats.type}</td>
                        <td>${stats.races}</td>
                        <td>${winRate.toFixed(1)}%</td>
                        <td>${avgPlace.toFixed(2)}</td>
                        <td>${avgOdds > 0 ? avgOdds.toFixed(1) : 'N/A'}</td>
                    `;
                });
            
            individualAugmentSection.appendChild(augmentTable);
            advancedSection.appendChild(individualAugmentSection);
            
            // Create augment combo analysis section
            const comboSection = document.createElement('div');
            comboSection.innerHTML = '<h3>Top Augment Combinations</h3>';
            
            // Group by augment combinations
            const combos = {};
            
            allRaces.forEach(race => {
                const comboKey = `${race.cpuAugment || 'None'} / ${race.ramAugment || 'None'} / ${race.hydraulicAugment || 'None'}`;
                
                if (!combos[comboKey]) {
                    combos[comboKey] = { 
                        races: 0, 
                        wins: 0, 
                        placeSum: 0, 
                        oddsValues: [],
                        byBloodline: {
                            'Nakamoto': { races: 0, wins: 0, placeSum: 0, oddsValues: [] },
                            'Szabo': { races: 0, wins: 0, placeSum: 0, oddsValues: [] },
                            'Finney': { races: 0, wins: 0, placeSum: 0, oddsValues: [] },
                            'Buterin': { races: 0, wins: 0, placeSum: 0, oddsValues: [] }
                        }
                    };
                }
                
                combos[comboKey].races++;
                if (race.position === 1) combos[comboKey].wins++;
                combos[comboKey].placeSum += race.position;
                
                if (race.odds !== null && race.odds !== undefined && !isNaN(race.odds)) {
                    combos[comboKey].oddsValues.push(Number(race.odds));
                }
                
                // Also track by bloodline
                const bloodlineStats = combos[comboKey].byBloodline[race.bloodline];
                bloodlineStats.races++;
                if (race.position === 1) bloodlineStats.wins++;
                bloodlineStats.placeSum += race.position;
                
                if (race.odds !== null && race.odds !== undefined && !isNaN(race.odds)) {
                    bloodlineStats.oddsValues.push(Number(race.odds));
                }
            });
            
            // Create a table for top combinations
            const comboTable = document.createElement('table');
            comboTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Combination (C/R/H)</th>
                        <th>Races</th>
                        <th>Win %</th>
                        <th>Avg Place</th>
                        <th>Avg Odds</th>
                        <th>Best Bloodline</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            
            const comboTbody = comboTable.querySelector('tbody');
            
            // Get the top 10 combos by win rate
            Object.entries(combos)
                .filter(([, stats]) => stats.races >= 5) // Only show combos with at least 5 races
                .sort(([, statsA], [, statsB]) => {
                    const winRateA = statsA.races > 0 ? (statsA.wins / statsA.races) * 100 : 0;
                    const winRateB = statsB.races > 0 ? (statsB.wins / statsB.races) * 100 : 0;
                    return winRateB - winRateA;
                })
                .slice(0, 10) // Take top 10
                .forEach(([comboKey, stats]) => {
                    const winRate = stats.races > 0 ? (stats.wins / stats.races) * 100 : 0;
                    const avgPlace = stats.races > 0 ? stats.placeSum / stats.races : 0;
                    const avgOdds = stats.oddsValues.length > 0 
                        ? stats.oddsValues.reduce((sum, odds) => sum + odds, 0) / stats.oddsValues.length 
                        : 0;
                    
                    // Find best bloodline for this combo
                    let bestBloodline = 'N/A';
                    let bestWinRate = 0;
                    
                    Object.entries(stats.byBloodline).forEach(([bloodline, bloodlineStats]) => {
                        if (bloodlineStats.races < 3) return; // Require at least 3 races
                        
                        const winRate = bloodlineStats.races > 0 ? (bloodlineStats.wins / bloodlineStats.races) * 100 : 0;
                        if (winRate > bestWinRate) {
                            bestWinRate = winRate;
                            bestBloodline = `${bloodline} (${winRate.toFixed(1)}%)`;
                        }
                    });
                    
                    const row = comboTbody.insertRow();
                    row.innerHTML = `
                        <td>${comboKey}</td>
                        <td>${stats.races}</td>
                        <td>${winRate.toFixed(1)}%</td>
                        <td>${avgPlace.toFixed(2)}</td>
                        <td>${avgOdds > 0 ? avgOdds.toFixed(1) : 'N/A'}</td>
                        <td>${bestBloodline}</td>
                    `;
                });
            
            comboSection.appendChild(comboTable);
            advancedSection.appendChild(comboSection);
            
            // Add some styling for the advanced analytics section
            const style = document.createElement('style');
            style.textContent = `
                .advanced-augment-analysis {
                    margin-top: 40px;
                    border-top: 1px solid var(--border-color);
                    padding-top: 20px;
                }
                .advanced-augment-analysis h2 {
                    color: var(--accent-color);
                    margin-bottom: 20px;
                }
                .advanced-augment-analysis h3 {
                    margin-top: 25px;
                    margin-bottom: 10px;
                }
            `;
            
            document.head.appendChild(style);
            container.appendChild(advancedSection);
        }

        // --- Tab Handling --- //
        function initializeTabs() {
             const lastActiveTab = localStorage.getItem('zedTrackerActiveTab') || 'racing'; // Default to racing
             activateTab(lastActiveTab);
        }

        function handleTabClick(event) {
             if (event.target.classList.contains('tab-button')) {
                 const tabId = event.target.dataset.tab;
                 activateTab(tabId);
                 localStorage.setItem('zedTrackerActiveTab', tabId); // Save active tab
                 
                 // Render analysis tables if Analysis tab is selected
                 if (tabId === 'analysis') {
                     renderBloodlineAnalysis();
                     renderIndividualAugmentAnalysis();
                     renderAugmentPairAnalysis();
                     renderTripleAugmentAnalysis();
                 }
             }
        }

        function activateTab(tabId) {
            console.log(`Attempting to activate tab: ${tabId}`); // Corrected syntax
             tabButtons.forEach(button => {
                 button.classList.toggle('active', button.dataset.tab === tabId);
             });
             tabContents.forEach(content => {
                  // Use ID matching for content activation
                 const contentId = `tab-content-${tabId}`;
                 const shouldBeActive = content.id === contentId;
                 console.log(`Checking content div #${content.id}: Should be active? ${shouldBeActive}`); // Corrected syntax
                  content.classList.toggle('active', shouldBeActive);
             });
             console.log(`Activated tab: ${tabId}`);
             
             // Render analysis tables if Analysis tab is activated
             if (tabId === 'analysis') {
                 renderBloodlineAnalysis();
                 renderIndividualAugmentAnalysis();
                 renderAugmentPairAnalysis();
                 renderTripleAugmentAnalysis();
             }
        }
        
        // --- Modal Handling Functions ---
        // Note: Modal element variables are now accessed from the global scope
        function showHorseDetailsModal(horseId) {
            const horse = horses.find(h => h.id === horseId);
            if (!horse) {
                console.error("Horse not found for details modal:", horseId);
                return;
            }

            modalTitle.textContent = horse.name;

            // --- Calculate Basic Racing Stats ---
            const horseRaces = races.filter(r => r.horseId === horse.id);
            let wins = 0;
            let places = 0;
            let shows = 0;
            horseRaces.forEach(race => {
                const position = Number(race.position);
                if (position === 1) wins++;
                else if (position === 2) places++;
                else if (position === 3) shows++;
            });
            const totalRaces = horseRaces.length;
            const winRate = totalRaces > 0 ? (wins / totalRaces) * 100 : 0;

            modalStatsContent.innerHTML = `
                <p><strong>Bloodline:</strong> ${horse.bloodline}</p>
                <p><strong>Gender:</strong> ${horse.gender}</p>
                <p><strong>Status:</strong> ${horse.status}</p>
                <hr style="border-color: var(--border-color); margin: 1em 0;">
                <p><strong>Total Races:</strong> ${totalRaces}</p>
                <p><strong>Record (W-P-S):</strong> ${wins}-${places}-${shows}</p>
                <p><strong>Win Rate:</strong> ${winRate.toFixed(1)}%</p>
            `;

            // --- Calculate Augment Analysis ---
            modalAnalysisContent.innerHTML = ''; // Clear previous
            if (horseRaces.length > 0) {
                const analysis = {};
                horseRaces.forEach(race => {
                    const comboKey = `${race.cpuAugment || 'None'} / ${race.ramAugment || 'None'} / ${race.hydraulicAugment || 'None'}`;
                    if (!analysis[comboKey]) {
                        analysis[comboKey] = { races: 0, wins: 0, placeSum: 0, oddsSum: 0, racesWithOdds: 0 };
                    }
                    analysis[comboKey].races++;
                    if (race.position === 1) analysis[comboKey].wins++;
                    analysis[comboKey].placeSum += race.position;
                    if (race.odds !== null && race.odds !== undefined && !isNaN(race.odds)) {
                         analysis[comboKey].oddsSum += Number(race.odds);
                         analysis[comboKey].racesWithOdds++; // Increment only if odds exist
                    }
                });

                 const table = document.createElement('table');
                 table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Augment Combo (C/R/H)</th>
                            <th>Races</th>
                            <th>Win %</th>
                            <th>Avg Place</th>
                            <th>Avg Odds</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = table.querySelector('tbody');

                 Object.entries(analysis).sort(([keyA], [keyB]) => keyA.localeCompare(keyB)).forEach(([comboKey, stats]) => {
                     const winRate = stats.races > 0 ? (stats.wins / stats.races) * 100 : 0;
                     const avgPlace = stats.races > 0 ? stats.placeSum / stats.races : 0;
                     const avgOdds = stats.racesWithOdds > 0 ? stats.oddsSum / stats.racesWithOdds : 0;

                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${comboKey}</td>
                        <td>${stats.races}</td>
                        <td>${winRate.toFixed(1)}%</td>
                        <td>${avgPlace.toFixed(2)}</td>
                        <td>${avgOdds > 0 ? avgOdds.toFixed(1) : 'N/A'}</td>
                    `;
                });
                modalAnalysisContent.appendChild(table);
            } else {
                modalAnalysisContent.innerHTML = '<p>No race history found for augment analysis.</p>';
            }

            modal.style.display = "block";
        }

        function hideHorseDetailsModal() {
            // Access global modal variable
            if (modal) modal.style.display = "none";
            // Optional: Clear content on close
            if (modalTitle) modalTitle.textContent = '';
            if (modalStatsContent) modalStatsContent.innerHTML = '';
            if (modalAnalysisContent) modalAnalysisContent.innerHTML = '';
        }
        
        function renderBloodlineAnalysis() {
            const tbody = document.getElementById('bloodline-analysis-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Get all races for active racing horses with bloodline information
            const racesWithBloodline = [];
            horses.filter(h => h.status === 'racing').forEach(horse => {
                races.filter(r => r.horseId === horse.id).forEach(race => {
                    racesWithBloodline.push({
                        ...race,
                        bloodline: horse.bloodline
                    });
                });
            });
            
            if (racesWithBloodline.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="6">No race data available</td>';
                return;
            }
            
            // Group by bloodline
            const bloodlineData = {};
            const bloodlines = ['Nakamoto', 'Szabo', 'Finney', 'Buterin'];
            
            bloodlines.forEach(bloodline => {
                const bloodlineRaces = racesWithBloodline.filter(race => race.bloodline === bloodline);
                
                if (bloodlineRaces.length === 0) return;
                
                const wins = bloodlineRaces.filter(r => r.position === 1).length;
                const totalRaces = bloodlineRaces.length;
                const winRate = (wins / totalRaces) * 100;
                
                const placesSum = bloodlineRaces.reduce((sum, race) => sum + race.position, 0);
                const avgPlace = placesSum / totalRaces;
                
                // Calculate average odds (excluding races with missing odds)
                const racesWithOdds = bloodlineRaces.filter(r => r.odds !== null && r.odds !== undefined && !isNaN(r.odds));
                const oddsSum = racesWithOdds.reduce((sum, race) => sum + parseFloat(race.odds), 0);
                const avgOdds = racesWithOdds.length > 0 ? oddsSum / racesWithOdds.length : 0;
                
                // Calculate ROI
                const zedChange = bloodlineRaces.reduce((sum, race) => sum + (parseFloat(race.zedChange) || 0), 0);
                const zedInvested = bloodlineRaces.filter(r => r.zedChange < 0).reduce((sum, race) => sum + Math.abs(parseFloat(race.zedChange) || 0), 0);
                const roi = zedInvested > 0 ? (zedChange / zedInvested) * 100 : 0;
                
                bloodlineData[bloodline] = {
                    races: totalRaces,
                    winRate: winRate,
                    avgPlace: avgPlace,
                    avgOdds: avgOdds,
                    roi: roi
                };
            });
            
            // Sort bloodlines by win rate (highest first)
            bloodlines
                .filter(bloodline => bloodlineData[bloodline])
                .sort((a, b) => bloodlineData[b].winRate - bloodlineData[a].winRate)
                .forEach(bloodline => {
                    const data = bloodlineData[bloodline];
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${bloodline}</td>
                        <td>${data.races}</td>
                        <td>${data.winRate.toFixed(1)}%</td>
                        <td>${data.avgPlace.toFixed(2)}</td>
                        <td>${data.avgOdds > 0 ? data.avgOdds.toFixed(1) : 'N/A'}</td>
                    `;
                });
        }
        
        // Render individual augment analysis
        function renderIndividualAugmentAnalysis() {
            const tbody = document.getElementById('individual-augment-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Get filter values
            const minRaces = parseInt(document.getElementById('augment-analysis-min-races').value) || 5;
            const filterBloodline = document.getElementById('augment-analysis-bloodline-filter').value;
            
            // Get all races with augment and bloodline information
            const racesWithData = [];
            horses.filter(h => h.status === 'racing' && (!filterBloodline || h.bloodline === filterBloodline)).forEach(horse => {
                races.filter(r => r.horseId === horse.id).forEach(race => {
                    racesWithData.push({
                        ...race,
                        bloodline: horse.bloodline
                    });
                });
            });
            
            if (racesWithData.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="7">No race data available</td>';
                return;
            }
            
            // Analyze individual augments
            const augmentStats = {};
            
            racesWithData.forEach(race => {
                // Process CPU augment if not None
                if (race.cpuAugment && race.cpuAugment !== 'None') {
                    if (!augmentStats[race.cpuAugment]) {
                        augmentStats[race.cpuAugment] = { type: 'CPU', races: 0, wins: 0, places: 0, shows: 0, placeSum: 0, oddsValues: [], zedChange: 0 };
                    }
                    augmentStats[race.cpuAugment].races++;
                    if (race.position === 1) augmentStats[race.cpuAugment].wins++;
                    if (race.position === 2) augmentStats[race.cpuAugment].places++;
                    if (race.position === 3) augmentStats[race.cpuAugment].shows++;
                    augmentStats[race.cpuAugment].placeSum += race.position;
                    if (race.odds !== null && race.odds !== undefined && !isNaN(race.odds)) {
                        augmentStats[race.cpuAugment].oddsValues.push(parseFloat(race.odds));
                    }
                    if (race.zedChange !== null && race.zedChange !== undefined) {
                        augmentStats[race.cpuAugment].zedChange += parseFloat(race.zedChange);
                    }
                }
                
                // Process RAM augment if not None
                if (race.ramAugment && race.ramAugment !== 'None') {
                    if (!augmentStats[race.ramAugment]) {
                        augmentStats[race.ramAugment] = { type: 'RAM', races: 0, wins: 0, places: 0, shows: 0, placeSum: 0, oddsValues: [], zedChange: 0 };
                    }
                    augmentStats[race.ramAugment].races++;
                    if (race.position === 1) augmentStats[race.ramAugment].wins++;
                    if (race.position === 2) augmentStats[race.ramAugment].places++;
                    if (race.position === 3) augmentStats[race.ramAugment].shows++;
                    augmentStats[race.ramAugment].placeSum += race.position;
                    if (race.odds !== null && race.odds !== undefined && !isNaN(race.odds)) {
                        augmentStats[race.ramAugment].oddsValues.push(parseFloat(race.odds));
                    }
                    if (race.zedChange !== null && race.zedChange !== undefined) {
                        augmentStats[race.ramAugment].zedChange += parseFloat(race.zedChange);
                    }
                }
                
                // Process Hydraulic augment if not None
                if (race.hydraulicAugment && race.hydraulicAugment !== 'None') {
                    if (!augmentStats[race.hydraulicAugment]) {
                        augmentStats[race.hydraulicAugment] = { type: 'Hydraulic', races: 0, wins: 0, places: 0, shows: 0, placeSum: 0, oddsValues: [], zedChange: 0 };
                    }
                    augmentStats[race.hydraulicAugment].races++;
                    if (race.position === 1) augmentStats[race.hydraulicAugment].wins++;
                    if (race.position === 2) augmentStats[race.hydraulicAugment].places++;
                    if (race.position === 3) augmentStats[race.hydraulicAugment].shows++;
                    augmentStats[race.hydraulicAugment].placeSum += race.position;
                    if (race.odds !== null && race.odds !== undefined && !isNaN(race.odds)) {
                        augmentStats[race.hydraulicAugment].oddsValues.push(parseFloat(race.odds));
                    }
                    if (race.zedChange !== null && race.zedChange !== undefined) {
                        augmentStats[race.hydraulicAugment].zedChange += parseFloat(race.zedChange);
                    }
                }
            });
            
            // Filter augments with minimum races and calculate metrics
            const augmentData = [];
            Object.entries(augmentStats).forEach(([name, stats]) => {
                if (stats.races < minRaces) return;
                
                const winRate = (stats.wins / stats.races) * 100;
                const avgPlace = stats.placeSum / stats.races;
                const avgOdds = stats.oddsValues.length > 0 
                    ? stats.oddsValues.reduce((sum, odds) => sum + odds, 0) / stats.oddsValues.length 
                    : 0;
                    
                // Calculate ROI
                const roi = (stats.zedChange / stats.races) * 100;
                
                augmentData.push({
                    name,
                    type: stats.type,
                    races: stats.races,
                    winRate,
                    avgPlace,
                    avgOdds,
                    roi
                });
            });
            
            // Sort by win rate (highest first)
            augmentData.sort((a, b) => b.winRate - a.winRate);
            
            // Render table
            if (augmentData.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `<td colspan="5">No augments with at least ${minRaces} races</td>`;
                return;
            }
            
            augmentData.forEach(data => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${data.name}</td>
                    <td>${data.type}</td>
                    <td>${data.races}</td>
                    <td>${data.winRate.toFixed(1)}%</td>
                    <td>${data.avgPlace.toFixed(2)}</td>
                    <td>${data.avgOdds > 0 ? data.avgOdds.toFixed(1) : 'N/A'}</td>
                `;
            });
        }
        
        // Render augment pair analysis
        function renderAugmentPairAnalysis() {
            const tbody = document.getElementById('augment-pair-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Get filter values
            const minRaces = parseInt(document.getElementById('augment-analysis-min-races').value) || 5;
            const filterBloodline = document.getElementById('augment-analysis-bloodline-filter').value;
            
            // Get all races with augment and bloodline information
            const racesWithData = [];
            horses.filter(h => h.status === 'racing' && (!filterBloodline || h.bloodline === filterBloodline)).forEach(horse => {
                races.filter(r => r.horseId === horse.id).forEach(race => {
                    racesWithData.push({
                        ...race,
                        bloodline: horse.bloodline
                    });
                });
            });
            
            if (racesWithData.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="5">No race data available</td>';
                return;
            }
            
            // Find all augment pairs used together
            const pairStats = {};
            
            racesWithData.forEach(race => {
                const augments = [
                    race.cpuAugment !== 'None' ? race.cpuAugment : null,
                    race.ramAugment !== 'None' ? race.ramAugment : null,
                    race.hydraulicAugment !== 'None' ? race.hydraulicAugment : null
                ].filter(a => a !== null);
                
                // Only process if 2 or more augments were used
                if (augments.length >= 2) {
                    // Generate all pairs (combinations of 2)
                    for (let i = 0; i < augments.length; i++) {
                        for (let j = i + 1; j < augments.length; j++) {
                            const pair = [augments[i], augments[j]].sort().join(' + ');
                            
                            if (!pairStats[pair]) {
                                pairStats[pair] = { races: 0, wins: 0, placeSum: 0, oddsValues: [], zedChange: 0 };
                            }
                            
                            pairStats[pair].races++;
                            if (race.position === 1) pairStats[pair].wins++;
                            pairStats[pair].placeSum += race.position;
                            if (race.odds !== null && race.odds !== undefined && !isNaN(race.odds)) {
                                pairStats[pair].oddsValues.push(parseFloat(race.odds));
                            }
                            if (race.zedChange !== null && race.zedChange !== undefined) {
                                pairStats[pair].zedChange += parseFloat(race.zedChange);
                            }
                        }
                    }
                }
            });
            
            // Filter pairs with minimum races and calculate metrics
            const pairData = [];
            Object.entries(pairStats).forEach(([pair, stats]) => {
                if (stats.races < minRaces) return;
                
                const winRate = (stats.wins / stats.races) * 100;
                const avgPlace = stats.placeSum / stats.races;
                const avgOdds = stats.oddsValues.length > 0 
                    ? stats.oddsValues.reduce((sum, odds) => sum + odds, 0) / stats.oddsValues.length 
                    : 0;
                    
                // Calculate ROI
                const roi = (stats.zedChange / stats.races) * 100;
                
                pairData.push({
                    pair,
                    races: stats.races,
                    winRate,
                    avgPlace,
                    avgOdds,
                    roi
                });
            });
            
            // Sort by win rate (highest first)
            pairData.sort((a, b) => b.winRate - a.winRate);
            
            // Render table
            if (pairData.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `<td colspan="5">No augment pairs with at least ${minRaces} races</td>`;
                return;
            }
            
            pairData.forEach(data => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${data.pair}</td>
                    <td>${data.races}</td>
                    <td>${data.winRate.toFixed(1)}%</td>
                    <td>${data.avgPlace.toFixed(2)}</td>
                    <td>${data.avgOdds > 0 ? data.avgOdds.toFixed(1) : 'N/A'}</td>
                `;
            });
        }
        
        // Render triple augment analysis 
        function renderTripleAugmentAnalysis() {
            const tbody = document.getElementById('augment-triple-body');
            if (!tbody) {
                console.error('Triple augment table body not found!');
                return;
            }
            
            console.log("Rendering Triple Augment Analysis");
            tbody.innerHTML = '';
            
            // Get filter values - properly parse as integers with fallback
            const minRacesInput = document.getElementById('augment-analysis-min-races');
            const minRacesValue = minRacesInput ? minRacesInput.value : "5";
            const minRaces = parseInt(minRacesValue) || 2; // Default to 2 if parsing fails
            console.log("Triple Augment Analysis using minRaces:", minRaces);
            
            const filterBloodline = document.getElementById('augment-analysis-bloodline-filter').value;
            console.log("Triple Augment Analysis using bloodline filter:", filterBloodline || "All");
            
            // Get all races with augment and bloodline information
            const racesWithData = [];
            horses.filter(h => h.status === 'racing' && (!filterBloodline || h.bloodline === filterBloodline)).forEach(horse => {
                races.filter(r => r.horseId === horse.id).forEach(race => {
                    racesWithData.push({
                        ...race,
                        bloodline: horse.bloodline
                    });
                });
            });
            
            if (racesWithData.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="5">No race data available</td>';
                return;
            }
            
            // Analyze triple augment combinations
            const tripleStats = {};
            
            racesWithData.forEach(race => {
                if (race.cpuAugment !== 'None' && race.ramAugment !== 'None' && race.hydraulicAugment !== 'None') {
                    const combo = `${race.cpuAugment} / ${race.ramAugment} / ${race.hydraulicAugment}`;
                    
                    if (!tripleStats[combo]) {
                        tripleStats[combo] = { races: 0, wins: 0, placeSum: 0, oddsValues: [], zedChange: 0 };
                    }
                    
                    tripleStats[combo].races++;
                    if (race.position === 1) tripleStats[combo].wins++;
                    tripleStats[combo].placeSum += race.position;
                    if (race.odds !== null && race.odds !== undefined && !isNaN(race.odds)) {
                        tripleStats[combo].oddsValues.push(parseFloat(race.odds));
                    }
                    if (race.zedChange !== null && race.zedChange !== undefined) {
                        tripleStats[combo].zedChange += parseFloat(race.zedChange);
                    }
                }
            });
            
            // Log stats before filtering to help debug
            console.log(`Found ${Object.keys(tripleStats).length} triple augment combinations before filtering`);
            
            // Filter combinations with minimum races and calculate metrics
            const tripleData = [];
            Object.entries(tripleStats).forEach(([combo, stats]) => {
                if (stats.races < minRaces) return;
                
                const winRate = (stats.wins / stats.races) * 100;
                const avgPlace = stats.placeSum / stats.races;
                const avgOdds = stats.oddsValues.length > 0 
                    ? stats.oddsValues.reduce((sum, odds) => sum + odds, 0) / stats.oddsValues.length 
                    : 0;
                    
                // Calculate ROI
                const roi = (stats.zedChange / stats.races) * 100;
                
                tripleData.push({
                    combo,
                    races: stats.races,
                    winRate,
                    avgPlace,
                    avgOdds,
                    roi
                });
            });
            
            console.log(`Triple augment combinations after filtering (min ${minRaces} races):`, tripleData.length);
            
            // Sort by win rate (highest first)
            tripleData.sort((a, b) => b.winRate - a.winRate);
            
            // Render table
            if (tripleData.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `<td colspan="5">No triple combinations with at least ${minRaces} races</td>`;
                return;
            }
            
            tripleData.forEach(data => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${data.combo}</td>
                    <td>${data.races}</td>
                    <td>${data.winRate.toFixed(1)}%</td>
                    <td>${data.avgPlace.toFixed(2)}</td>
                    <td>${data.avgOdds > 0 ? data.avgOdds.toFixed(1) : 'N/A'}</td>
                `;
            });
            
            console.log("Triple Augment Analysis completed");
        }

        // Function to populate the horse filter dropdown in augment analysis
        function populateAugmentAnalysisHorseFilter() {
            if (!augmentAnalysisHorseFilter) return;
            
            // Clear existing options except the first "All Horses" option
            while (augmentAnalysisHorseFilter.options.length > 1) {
                augmentAnalysisHorseFilter.remove(1);
            }
            
            // Get racing horses only
            const racingHorses = horses.filter(h => h.status === 'racing');
            
            // Sort alphabetically by name
            racingHorses.sort((a, b) => a.name.localeCompare(b.name));
            
            // Add options for each horse
            racingHorses.forEach(horse => {
                const option = document.createElement('option');
                option.value = horse.id;
                option.textContent = horse.name;
                augmentAnalysisHorseFilter.appendChild(option);
            });
        }

        // Helper function to get the correctly filtered list of horses WITH their stats
        function getFilteredRacingHorses() {
            const filterBloodline = horseFilterBloodline.value;
            const filterGender = horseFilterGender.value;
            const minStars = parseFloat(horseFilterMinStars.value) || null;
            const maxStars = parseFloat(horseFilterMaxStars.value) || null;
            const minSpeed = parseFloat(horseFilterMinSpeed.value) || null;
            const maxSpeed = parseFloat(horseFilterMaxSpeed.value) || null;
            const minSprint = parseFloat(horseFilterMinSprint.value) || null;
            const maxSprint = parseFloat(horseFilterMaxSprint.value) || null;
            const minEndurance = parseFloat(horseFilterMinEndurance.value) || null;
            const maxEndurance = parseFloat(horseFilterMaxEndurance.value) || null;

            // Helper function to check star ranges (handles null/undefined horse stars)
            const checkStarRange = (horseStars, minFilter, maxFilter) => {
                const stars = (horseStars !== null && horseStars !== undefined && horseStars !== '') ? parseFloat(horseStars) : null;
                // If a filter is active for this star type, but the horse doesn't have the star value, exclude it.
                if ((minFilter !== null || maxFilter !== null) && stars === null) return false;
                // If no filter is active OR the horse has the star, proceed with range check.
                const minMatch = (minFilter === null || (stars !== null && stars >= minFilter));
                const maxMatch = (maxFilter === null || (stars !== null && stars <= maxFilter));
                return minMatch && maxMatch;
            };

            // First, calculate stats for ALL active racing horses (needed for sorting later)
            const allRacingHorsesWithStats = horses
                .filter(h => h.status === 'racing')
                .map(horse => ({ ...horse, calculatedStats: calculateHorseStats(horse.id) }));

            // Then, apply filters to the list with stats
            const filteredHorses = allRacingHorsesWithStats.filter(horseData => {
                const h = horseData; // horse object
                //const stats = horseData.calculatedStats; // We aren't filtering by stats currently

                const bloodlineMatch = !filterBloodline || h.bloodline === filterBloodline;
                const genderMatch = !filterGender || h.gender === filterGender;
                const overallStarsMatch = checkStarRange(h.stars, minStars, maxStars);
                const speedStarsMatch = checkStarRange(h.speedStars, minSpeed, maxSpeed);
                const sprintStarsMatch = checkStarRange(h.sprintStars, minSprint, maxSprint);
                const enduranceStarsMatch = checkStarRange(h.enduranceStars, minEndurance, maxEndurance);

                return bloodlineMatch && genderMatch && overallStarsMatch && speedStarsMatch && sprintStarsMatch && enduranceStarsMatch;
            });
            return filteredHorses;
        }

        // Update the visual sort indicators in the table headers
        function updateSortIndicators() {
            const headers = document.querySelectorAll('#horses-table th[data-sort-key]');
            headers.forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sortKey === racingHorseSort.key) {
                    th.classList.add(racingHorseSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }
        
        // --- Rendering for Bred Horses History ---
        function renderBredHorsesTable() {
            bredHorsesTableBody.innerHTML = '';
            const allHorses = [...horses]; // Use unified list to find parent names
            const formatStars = (stars) => (stars !== null && stars !== undefined && stars !== '') ? Number(stars).toFixed(1) : '-';
 
            // Sort by date descending (already done before pagination)
            const sortedBred = [...bredHorses].sort((a,b) => {
                const dateA = a.bredDate ? new Date(a.bredDate) : 0;
                const dateB = b.bredDate ? new Date(b.bredDate) : 0;
                return dateB - dateA; // Descending
            });

            // Pagination Calculation for Bred History
            const totalItems = sortedBred.length;
            const totalPages = Math.ceil(totalItems / bredHistoryTableItemsPerPage);
            if (bredHistoryTableCurrentPage > totalPages) {
                bredHistoryTableCurrentPage = Math.max(totalPages, 1);
            }
            const startIndex = (bredHistoryTableCurrentPage - 1) * bredHistoryTableItemsPerPage;
            const endIndex = startIndex + bredHistoryTableItemsPerPage;
            const bredToShow = sortedBred.slice(startIndex, endIndex);

            // Render the sliced rows
            bredToShow.forEach(bred => {
                // Find parent names (internal or external)
                let sireName = 'N/A';
                if (bred.externalSireName) {
                    // Format external sire name and stars
                    const overall = formatStars(bred.externalSireOverallStars);
                    const speed = formatStars(bred.externalSireSpeedStars);
                    const sprint = formatStars(bred.externalSireSprintStars);
                    const endurance = formatStars(bred.externalSireEnduranceStars);
                    sireName = `${bred.externalSireName} (Ext. O:${overall}/Sp:${speed}/Sr:${sprint}/E:${endurance})`;
                } else if (bred.sireId) {
                    const sire = allHorses.find(h => h.id === bred.sireId);
                    sireName = sire ? sire.name : `(Deleted: ID ${bred.sireId})`;
                }
                let damName = 'N/A';
                if (bred.damId) { // Dams are assumed internal
                    const dam = allHorses.find(h => h.id === bred.damId);
                    damName = dam ? dam.name : `(Deleted: ID ${bred.damId})`;
                }

                const row = bredHorsesTableBody.insertRow();
                row.innerHTML = `
                    <td>${bred.bredDate ? new Date(bred.bredDate).toLocaleDateString() : '-'}</td>
                    <td>${bred.name}</td>
                    <td>${bred.bloodline}</td>
                    <td>${bred.gender}</td>
                    <td>${sireName}</td>
                    <td>${damName}</td>
                    <td>${formatStars(bred.stars)}</td>
                    <td>${formatStars(bred.speedStars)}</td>
                    <td>${formatStars(bred.sprintStars)}</td>
                    <td>${formatStars(bred.enduranceStars)}</td>
                    <td>${bred.studFeePaid ? bred.studFeePaid.toFixed(2) : '0.00'}</td>
                    <td class="actions">
                        <button class="action-button edit-button" onclick="editBredHorse('${bred.id}')" title="Edit Bred Record">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="action-button delete-button" onclick="deleteBredHorse('${bred.id}')" title="Delete Bred Record">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    </td>
                `;
            });

            // Render Pagination Controls for Bred History
            renderBredHistoryPaginationControls(totalItems, totalPages);
        }

        // --- Pagination Control Rendering for Bred History Table ---
        function renderBredHistoryPaginationControls(totalItems, totalPages) {
            const pageNavContainer = bredHistoryPageInfoSpan?.parentElement;
            const controlsContainer = document.getElementById('bred-history-pagination-controls');

            if (!bredHistoryPageInfoSpan || !bredHistoryPrevPageButton || !bredHistoryNextPageButton || !controlsContainer || !pageNavContainer) {
                console.warn("Bred history pagination elements not found, skipping control render.");
                return;
            }

            controlsContainer.style.display = 'flex';

            if (totalItems === 0) {
                bredHistoryPageInfoSpan.textContent = 'No bred records found';
            } else {
                bredHistoryPageInfoSpan.textContent = `Page ${bredHistoryTableCurrentPage} of ${totalPages} (${totalItems} items)`;
            }

            bredHistoryPrevPageButton.disabled = bredHistoryTableCurrentPage <= 1;
            bredHistoryNextPageButton.disabled = bredHistoryTableCurrentPage >= totalPages;
            pageNavContainer.style.display = 'flex';
        }

        // --- Pagination Event Handlers for Bred History ---
        function handleBredHistoryItemsPerPageChange() {
            const newSize = parseInt(bredHistoryItemsPerPageSelect.value, 10);
            if (!isNaN(newSize) && newSize > 0) {
                bredHistoryTableItemsPerPage = newSize;
                bredHistoryTableCurrentPage = 1; // Reset to first page
                localStorage.setItem('bredHistoryTableItemsPerPage', bredHistoryTableItemsPerPage.toString()); // Save preference
                renderBredHorsesTable();
            }
        }

        function handleBredHistoryPrevPage() {
            if (bredHistoryTableCurrentPage > 1) {
                bredHistoryTableCurrentPage--;
                renderBredHorsesTable();
            }
        }

        function handleBredHistoryNextPage() {
            const totalItems = bredHorses.length; // Use full bred list length
            const totalPages = Math.ceil(totalItems / bredHistoryTableItemsPerPage);
            if (bredHistoryTableCurrentPage < totalPages) {
                bredHistoryTableCurrentPage++;
                renderBredHorsesTable();
            }
        }

        // --- Augment Management Handlers ---
        function handleAddAugment(event) {
            event.preventDefault();
            
            const augmentNameInput = document.getElementById('augment-name');
            const augmentTypeSelect = document.getElementById('augment-type');
            
            const augmentName = augmentNameInput.value.trim();
            const augmentType = augmentTypeSelect.value;
            
            // Validation
            if (!augmentName) {
                alert("Please enter an augment name.");
                return;
            }
            
            if (!augmentType) {
                alert("Please select an augment type (CPU, RAM, or Hydraulic).");
                return;
            }
            
            // Check which list to add to based on type
            let targetList;
            switch (augmentType) {
                case 'CPU':
                    targetList = cpuAugments;
                    break;
                case 'RAM':
                    targetList = ramAugments;
                    break;
                case 'Hydraulic':
                    targetList = hydraulicAugments;
                    break;
                default:
                    alert("Invalid augment type selected.");
                    return;
            }
            
            // Check for duplicates in the target list
            if (targetList.includes(augmentName)) {
                alert(`An augment named "${augmentName}" already exists in the ${augmentType} list.`);
                return;
            }
            
            // Add to the appropriate list
            targetList.push(augmentName);
            
            // Update UI
            populateAugmentDropdowns();
            saveData(); // Save to localStorage
            
            // Reset form
            augmentNameInput.value = '';
            augmentTypeSelect.value = '';
            
            console.log(`Added ${augmentName} to ${augmentType} augments list.`);
        }
        
        function handleDeleteAugment(augmentName, type) {
            if (!confirm(`Are you sure you want to delete the ${type} augment "${augmentName}"?`)) {
                return;
            }
            
            let targetList;
            switch (type) {
                case 'CPU':
                    targetList = cpuAugments;
                    break;
                case 'RAM':
                    targetList = ramAugments;
                    break;
                case 'Hydraulic':
                    targetList = hydraulicAugments;
                    break;
                default:
                    alert("Invalid augment type.");
                    return;
            }
            
            // Remove the augment from the list
            const index = targetList.indexOf(augmentName);
            if (index !== -1) {
                targetList.splice(index, 1);
                
                // Update UI
                populateAugmentDropdowns();
                saveData(); // Save to localStorage
                
                console.log(`Deleted ${augmentName} from ${type} augments list.`);
            } else {
                console.error(`Could not find augment "${augmentName}" in ${type} list.`);
            }
        }

        // --- Table Sorting Handler ---
        function handleSortClick(event) {
            const clickedHeader = event.currentTarget;
            const newSortKey = clickedHeader.dataset.sortKey;
            
            // If clicking the same column, toggle direction, otherwise set to asc
            if (newSortKey === racingHorseSort.key) {
                // Toggle direction
                racingHorseSort.direction = racingHorseSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // New column, start with ascending
                racingHorseSort.key = newSortKey;
                racingHorseSort.direction = 'asc';
            }
            
            // Re-render table with new sort
            renderHorsesTable();
            
            // Visual indicators already updated in renderHorsesTable -> updateSortIndicators
            console.log(`Sorted by ${racingHorseSort.key} (${racingHorseSort.direction})`);
        }

        // --- Data Export/Import Handlers ---
        function handleExportData() {
            // Prepare the data to export
            const dataToExport = {
                horses: horses,
                races: races,
                bredHorses: bredHorses,
                cpuAugments: cpuAugments,
                ramAugments: ramAugments,
                hydraulicAugments: hydraulicAugments,
                retirementEarnings: totalRetirementEarnings,
                version: '1.0', // Add version info for future compatibility
                exportDate: new Date().toISOString()
            };
            
            // Convert to JSON string
            const jsonData = JSON.stringify(dataToExport, null, 2); // Pretty-print with 2 spaces
            
            // Create a Blob and URL
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // Create a temporary download link
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            
            // Generate filename with date
            const date = new Date();
            const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            downloadLink.download = `zed_tracker_backup_${dateStr}.json`;
            
            // Append to document, click, and clean up
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(url);
            
            console.log("Data exported successfully");
        }
        
        function handleImportData(event) {
            const fileInput = event.target;
            const file = fileInput.files[0];
            
            if (!file) {
                console.log("No file selected");
                return;
            }
            
            // Check if it's a JSON file
            if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
                alert("Please select a valid JSON backup file.");
                fileInput.value = ''; // Clear the input
                return;
            }
            
            if (!confirm("WARNING: Importing data will replace all current horses, races, and settings. This cannot be undone. Continue?")) {
                fileInput.value = ''; // Clear the input
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Basic validation - check for required data
                    if (!importedData.horses || !Array.isArray(importedData.horses) ||
                        !importedData.races || !Array.isArray(importedData.races)) {
                        throw new Error("Invalid backup file: Missing required data");
                    }
                    
                    // Import data
                    horses = importedData.horses || [];
                    races = importedData.races || [];
                    bredHorses = importedData.bredHorses || [];
                    cpuAugments = importedData.cpuAugments || [...cpuAugments]; // Fallback to current if missing
                    ramAugments = importedData.ramAugments || [...ramAugments];
                    hydraulicAugments = importedData.hydraulicAugments || [...hydraulicAugments];
                    totalRetirementEarnings = importedData.retirementEarnings || 0;
                    
                    // Save and refresh
                    saveData();
                    location.reload(); // Refresh the page to update everything
                    
                    alert("Data imported successfully!");
                } catch (error) {
                    console.error("Error importing data:", error);
                    alert("Error importing data. Please ensure you selected a valid Zed Tracker backup file.");
                }
                fileInput.value = ''; // Clear the input
            };
            
            reader.onerror = function() {
                alert("Error reading file. Please try again.");
                fileInput.value = ''; // Clear the input
            };
            
            reader.readAsText(file);
        }

        function editRace(raceId) {
            const race = races.find(r => r.id === raceId);
            if (!race) {
                console.error("Race not found for editing:", raceId);
                return;
            }
            
            // Store the race being edited
            currentlyEditingRace = race;
            
            // Populate the race form with the race data
            const raceHorseSelect = document.getElementById('race-horse');
            const positionInput = document.getElementById('race-position');
            const oddsInput = document.getElementById('race-odds');
            const timeInput = document.getElementById('race-finish-time');
            const zedChangeInput = document.getElementById('race-zed-change');
            const ratingChangeInput = document.getElementById('race-rating-change');
            const cpuSelect = document.getElementById('race-cpu-augment');
            const ramSelect = document.getElementById('race-ram-augment');
            const hydraulicSelect = document.getElementById('race-hydraulic-augment');
            
            // Set form values
            raceHorseSelect.value = race.horseId;
            positionInput.value = race.position;
            oddsInput.value = race.odds;
            timeInput.value = race.finishTime || '';
            zedChangeInput.value = race.zedChange;
            ratingChangeInput.value = race.ratingChange !== null ? race.ratingChange : '';
            cpuSelect.value = race.cpuAugment;
            ramSelect.value = race.ramAugment;
            hydraulicSelect.value = race.hydraulicAugment;
            
            // Update button text to indicate editing
            const submitButton = document.getElementById('add-race-form').querySelector('button[type="submit"]');
            submitButton.textContent = 'Update Race';
            
            // Scroll to the form
            document.getElementById('races-section').scrollIntoView({ behavior: 'smooth' });
        }

    </script>

</body>
<!-- Horse Details Modal Structure -->
<div id="horse-details-modal" class="modal">
    <div class="modal-content">
        <span class="modal-close" id="modal-close-button">&times;</span>
        <h3 id="modal-horse-name">Horse Details</h3>
        <div id="modal-stats-content" class="modal-stats">
            <!-- Basic stats loaded here -->
        </div>
        <h4>Augment Performance</h4>
        <div id="modal-analysis-content">
            <!-- Augment analysis table loaded here -->
        </div>
    </div>
</div>

</html>
</html>